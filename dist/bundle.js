!function(){"use strict";function e(e){document.querySelectorAll("input, select, textarea").forEach(e=>{e.id&&("checkbox"===e.type||"radio"===e.type?localStorage.setItem(e.id,e.checked):localStorage.setItem(e.id,e.value))});document.querySelectorAll(".step").forEach(t=>{const n=t.id===e;t.classList.toggle("active",n),t.classList.toggle("hidden",!n)}),function(e){const t=document.getElementById("progressBar");if(!t)return;const n=Array.from(document.querySelectorAll(".step")),o=n.findIndex(t=>t.id===e),a=(o+1)/n.length*100;t.style.width=`${a}%`}(e),localStorage.setItem("currentStep",e)}async function t(e,t,n){try{const a=await fetch(e);if(!a.ok)throw new Error("Network response was not ok");const i=await a.json();if(console.log(`📜 Dati ricevuti da ${e}:`,i),!i[n])return void o(`Chiave ${n} non trovata in ${e}`);!function(e,t){const n=document.getElementById(e);if(!n)return void o(`Elemento #${e} non trovato!`);n.innerHTML='<option value="">Seleziona...</option>',t.forEach(e=>{const t=document.createElement("option");t.value=e.path,t.textContent=e.name,n.appendChild(t)})}(t,Object.keys(i[n]).map(e=>({name:e,path:i[n][e]})))}catch(t){o(`Errore caricando ${e}: ${t}`)}}async function n(e,t,n,a){try{const i=await fetch(e);if(!i.ok)throw new Error("Network response was not ok");const s=await i.json();if(!s[t])return void o(`Chiave ${t} non trovata in ${e}`);const c=document.getElementById(n);if(!c)return void o(`Elemento #${n} non trovato!`);Object.entries(s[t]).forEach(([e,t])=>{const n=document.createElement("button");n.className="btn btn-primary",n.textContent=e,n.addEventListener("click",()=>a(e,t)),c.appendChild(n)})}catch(t){o(`Errore caricando ${e}: ${t}`)}}function o(e){console.error("❌ "+e),alert("⚠️ "+e)}function a(e,t=3){const n=document.createElement(`h${t}`);return n.textContent=e,n}function i(e){const t=document.createElement("p");return t.textContent=e,t}window.resetForm=function(){if(!confirm("Reset all character data?"))return;localStorage.clear(),document.querySelectorAll("input, select, textarea").forEach(e=>{"checkbox"===e.type||"radio"===e.type?e.checked=!1:"select"===e.tagName.toLowerCase()?e.selectedIndex=0:e.value=""}),document.querySelectorAll(".step").forEach((e,t)=>{const n=0===t;e.classList.toggle("active",n),e.classList.toggle("hidden",!n)});const e=document.getElementById("progressBar");e&&(e.style.width="0%")};let s=sessionStorage.getItem("selectedData")?JSON.parse(sessionStorage.getItem("selectedData")):{};function c(){return s}function l(){sessionStorage.setItem("selectedData",JSON.stringify(s))}async function r(e){try{const t=await fetch("data/spells.json");if(!t.ok)throw new Error("Failed to load spells");const n=await t.json();console.log("📖 Spells loaded:",n),e(n)}catch(e){console.error("❌ Error loading spells:",e)}}const d=["Alchemist's Supplies","Brewer's Supplies","Calligrapher's Tools","Carpenter's Tools","Cartographer's Tools","Cobbler's Tools","Cook's Utensils","Glassblower's Tools","Jeweler's Tools","Leatherworker's Tools","Mason's Tools","Painter's Supplies","Potter's Tools","Smith's Tools","Tinker's Tools","Weaver's Tools","Woodcarver's Tools","Bagpipes","Drum","Dulcimer","Flute","Lute","Lyre","Horn","Pan Flute","Shawm","Viol","Disguise Kit","Forgery Kit","Herbalism Kit","Navigator's Tools","Poisoner's Kit","Thieves' Tools","Dice Set","Dragonchess Set","Playing Card Set","Three-Dragon Ante Set","Vehicle (Land)","Vehicle (Water)"],u=["Common","Dwarvish","Elvish","Giant","Gnomish","Goblin","Halfling","Orc","Abyssal","Celestial","Draconic","Deep Speech","Infernal","Primordial","Sylvan","Undercommon"],m=["Acrobatics","Animal Handling","Arcana","Athletics","Deception","History","Insight","Intimidation","Investigation","Medicine","Nature","Perception","Performance","Persuasion","Religion","Sleight of Hand","Stealth","Survival"];function p(e,t,n,o=[]){const a={languages:u,skills:m,tools:d},i={languages:" (tutte le lingue disponibili)",skills:" (tutte le abilità disponibili)",tools:" (tutti gli strumenti disponibili)"},s=o.map(e=>e.toLowerCase());let c=t.filter(e=>!n.has(e.toLowerCase())||s.includes(e.toLowerCase()));return 0===c.length?(c=(a[e]||[]).filter(e=>!n.has(e.toLowerCase())||s.includes(e.toLowerCase())),{options:c,note:i[e]||""}):{options:c,note:""}}function g(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.entries?g(e.entries):e.items?g(e.items):"").join(" "):""}function h(e,t,n,o,a){const i=[];for(let a=0;a<t;a++){const t=document.createElement("select");t.className=o,t.dataset.options=JSON.stringify(n),e.appendChild(t),i.push(t)}const s=()=>{const e=new Set(i.map(e=>e.value).filter(Boolean));i.forEach(t=>{const n=JSON.parse(t.dataset.options),o=t.value;t.innerHTML='<option value="">Seleziona</option>'+n.map(t=>`<option value="${t}" ${e.has(t)&&t!==o?"disabled":""}>${t}</option>`).join(""),t.value=o}),a&&a()};return i.forEach(e=>e.addEventListener("change",s)),s(),i}const f={"Drow Magic":{type:"none"},"Skill Versatility":{type:"skills",count:2,options:m},Swim:{type:"none"},"Cantrip (Wizard)":{type:"spells",filter:"level=0|class=Wizard"}};function y(){const e=document.getElementById("variantFeatureChoice"),t=document.getElementById("variantExtraContainer");if(!t||!e||!e.value)return;const n=e.value,o=f[n];if(t.innerHTML="",o)if("skills"===o.type){t.innerHTML=`<p><strong>Seleziona ${o.count} skill per ${n}:</strong></p>`;const e=()=>{c()["Variant Feature Skills"]=[...t.querySelectorAll(".variantSkillChoice")].map(e=>e.value).filter(Boolean),l(),P("variantFeatureTrait")};h(t,o.count,o.options,"variantSkillChoice",e)}else"spells"===o.type&&r(e=>{const a=function(e,t){const n=t.split("|");return e.filter(e=>{let t=!0;return n.forEach(n=>{const o=n.split("=");if(2===o.length){const n=o[0].trim().toLowerCase(),a=o[1].trim().toLowerCase();"level"===n?parseInt(e.level)!==parseInt(a)&&(t=!1):"class"===n&&(e.spell_list&&e.spell_list.map(e=>e.toLowerCase()).includes(a)||(t=!1))}}),t})}(e,o.filter);t.innerHTML=a.length?`<p><strong>Seleziona un incantesimo per ${n}:</strong></p>\n            <select id="variantSpellChoice">\n              <option value="">Seleziona...</option>\n              ${a.map(e=>`<option value="${e.name}">${e.name}</option>`).join("")}\n            </select>`:`<p>Nessun incantesimo trovato per il filtro: ${o.filter}</p>`;const i=document.getElementById("variantSpellChoice");i&&(i.addEventListener("change",()=>{c()["Variant Feature Spell"]=[i.value],l(),P("variantFeatureTrait")}),P("variantFeatureTrait"))})}let E=[],v=0;function C(){return E}function S(e){E=e}function k(){return v}function b(e){v=e}const w={Cantrip:"Cantrips",Cantrips:"Cantrips","Skill Proficiency":"Skill Proficiency","Tool Proficiency":"Tool Proficiency","Fighting Style":"Fighting Style","Additional Fighting Style":"Fighting Style","Divine Domain":"Divine Domain",Metamagic:"Metamagic"},L={Cantrips:"Scegli i tuoi cantrip.","Skill Proficiency":"Seleziona le competenze nelle abilità.","Tool Proficiency":"Seleziona le competenze negli strumenti.","Fighting Style":"Scegli il tuo stile di combattimento.","Divine Domain":"Seleziona il tuo dominio divino.",Metamagic:"Scegli le opzioni di Metamagia."};let B=c();const I=document.getElementById("prevTrait"),x=document.getElementById("nextTrait"),$=document.getElementById("closeModal");function A(){B=c();const e=C();if(Object.entries({Languages:["languageSelection","Lingue Extra"],"Skill Proficiency":["skillSelectionContainer","Skill Proficiency"],"Tool Proficiency":["toolSelectionContainer","Tool Proficiency"]}).forEach(([e,[t,n]])=>{if(void 0!==B[e])!function(e,t,n){const o=document.getElementById(e);if(!o)return;const a=(B[n]||[]).filter(e=>e);a.length>0?(o.innerHTML=`<p><strong>${t}:</strong> ${a.join(", ")}</p>`,o.classList.remove("hidden")):(o.innerHTML="",o.classList.add("hidden"))}(t,n,e);else{const e=document.getElementById(t);e&&e.classList.add("hidden")}}),!e||0===e.length)return;const t=document.getElementById("extraSelectionTitle"),n=document.getElementById("extraSelectionDescription"),o=document.getElementById("extraSelectionContainer");if(!t||!n||!o)return;const a=e[k()];t.innerText=a.name;const i=a.description||L[a.name]||"";if(n.innerText=i,o.innerHTML="",a.selection){const e=w[a.name]||a.name,t=new Set(q({Languages:"languages","Skill Proficiency":"skills","Tool Proficiency":"tools"}[e]||"")),n=new Set((B[e]||[]).filter(e=>e));t.forEach(e=>n.add(e));let i="";for(let t=0;t<a.count;t++)i+=`<select class="extra-selection" data-category="${e}" data-index="${t}"><option value="">Seleziona...</option>`,a.selection.forEach(t=>{const o=n.has(t)&&!B[e]?.includes(t);i+=`<option value="${t}" ${o?"disabled":""}>${t}</option>`}),i+="</select><br>";o.innerHTML=i,document.querySelectorAll(".extra-selection").forEach(e=>{e.addEventListener("change",e=>{const t=e.target.getAttribute("data-category"),n=w[t]||t,o=e.target.getAttribute("data-index");B[n]||(B[n]=[]),B[n][o]=e.target.value,l(),A()})})}if(I&&x&&$){const t=k();I.disabled=0===t,x.disabled=t===e.length-1;const n=e.every(e=>B[e.name]&&B[e.name].filter(e=>e).length===e.count);t===e.length-1&&n?$.style.display="inline-block":$.style.display="none"}}function T(){const e=C();e&&0!==e.length&&A()}function _(e){e&&e.querySelectorAll("details").forEach(e=>{const t=e.querySelector("summary"),n=Array.from(e.childNodes).filter(e=>e!==t),o=document.createElement("div"),a=["accordion-item","feature-block",...e.classList];o.className=a.join(" "),e.id&&(o.id=e.id);const i=document.createElement("button");i.type="button",i.className="accordion-header",i.innerHTML=t?t.innerHTML:"",o.appendChild(i);const s=document.createElement("div");s.className="accordion-content",n.forEach(e=>s.appendChild(e)),o.appendChild(s),e.replaceWith(o)})}function M(e){e&&e.querySelectorAll(".accordion-header").forEach((e,t)=>{const n=e.nextElementSibling;if(e.setAttribute("role","button"),e.hasAttribute("tabindex")||e.setAttribute("tabindex","0"),e.setAttribute("aria-expanded","false"),n){const o=e.id||`accordion-header-${t}`;e.id=o,n.setAttribute("role","region"),n.setAttribute("aria-labelledby",o)}const o=()=>{const t="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",String(!t)),e.classList.toggle("active",!t),n&&n.classList.toggle("show",!t),e.focus()};e.addEventListener("click",o),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),o())})})}async function j(){console.log("🛠 Esecuzione displayRaceTraits()...");const e=c(),t=document.getElementById("raceSelect").value,n=document.getElementById("raceTraits"),s=document.getElementById("racialBonusSelection");if(!t)return console.warn("⚠️ displayRaceTraits(): Nessuna razza selezionata."),n.textContent="",n.appendChild(i("Seleziona una razza per vedere i tratti.")),s.style.display="none",void U();console.log(`📜 Caricamento tratti per ${t}...`);try{const o=await fetch(t);if(!o.ok)throw new Error("Network response was not ok");const s=await o.json();console.log("📜 Dati razza caricati:",s);const l=function(e){let t="Unknown";t=Array.isArray(e.size)?"M"===e.size[0]?"Medium":"S"===e.size[0]?"Small":e.size[0]:e.size||"Unknown";let n={};if(e.speed)if("object"==typeof e.speed)for(let t in e.speed)n[t]="boolean"==typeof e.speed[t]?"fly"===t?"equal to your walking speed":"unknown":e.speed[t];else n=e.speed;let o={};e.senses&&"object"==typeof e.senses?o=e.senses:e.darkvision&&(o.darkvision=e.darkvision);let a={options:[]};e.ability&&Array.isArray(e.ability)&&e.ability.forEach(e=>{if(e.choose&&e.choose.weighted){const t=e.choose.weighted.weights;2===t.length&&t.includes(2)?a.options.push({type:"fixed",values:{any:2,any_other:1}}):3===t.length&&a.options.push({type:"three",values:{any:1,any_other:1,any_other_2:1}})}});let i=null,s=[];const c=e.entries||[];c.forEach(e=>{if("inset"===e.type&&e.name&&e.name.toLowerCase().includes("variant feature")){i=(e.entries||[]).map(e=>({name:e.name,description:g(e.entries)}));const t=i.map(e=>`<strong>${e.name}:</strong> ${e.description}`).join(" ");s.push({name:e.name,description:t,level_requirement:1})}else e.name&&e.entries&&s.push({name:e.name,description:g(e.entries),level_requirement:e.level||1})});let l={fixed:[],choice:0,options:[]};if(e.languageProficiencies&&e.languageProficiencies.length>0){const t=e.languageProficiencies[0];for(let e in t)!0===t[e]?l.fixed.push(e.charAt(0).toUpperCase()+e.slice(1)):"number"==typeof t[e]&&(l.choice=t[e]);l.choice>0&&0===l.options.length&&l.options.push("Any other language you and your DM agree is appropriate")}let r=null;if(e.skillProficiencies&&e.skillProficiencies.length>0){const t=e.skillProficiencies[0];t.choose&&t.choose.from?r={number:t.choose.count?t.choose.count:1,options:t.choose.from}:"number"==typeof t.any&&(r={number:t.any,options:m})}let d=null;e.toolProficiencies&&Array.isArray(e.toolProficiencies)&&e.toolProficiencies.forEach(e=>{e.choose&&e.choose.from&&(d={number:1,options:e.choose.from})});let u=null;if(e.additionalSpells&&e.additionalSpells.length>0){const t=e.additionalSpells[0];if(u={},t.ability){let e=[];e=Array.isArray(t.ability)?t.ability:"object"==typeof t.ability&&t.ability.choose?Array.isArray(t.ability.choose)?t.ability.choose:[t.ability.choose]:[t.ability],u.ability_choices=e.map(e=>e.toString().toUpperCase())}if(t.known){const e=[];Object.values(t.known).forEach(t=>{(t._||[]).forEach(t=>{"string"==typeof t?e.push(t):t.choose&&(u.spell_choices={type:"filter",filter:t.choose})})}),!u.spell_choices&&e.length>1?u.spell_choices={type:"fixed_list",options:e}:1===e.length&&(u.fixed_spell=e[0])}}return{name:e.name,source:e.source+(e.page?`, page ${e.page}`:""),size:t,speed:n,senses:o,ability_bonus:a,traits:s,rawEntries:c,spellcasting:u,languages:l,skill_choices:r,tool_choices:d,variant_feature_choices:i}}(s);n.textContent="",n.appendChild(a(`Tratti di ${l.name}`,3));let d="Velocità: Non disponibile";if(l.speed)if("object"==typeof l.speed){d=`Velocità: ${Object.entries(l.speed).map(([e,t])=>`${e}: ${t} ft`).join(", ")}`}else d=`Velocità: ${l.speed} ft`;n.appendChild(i(d)),l.senses&&l.senses.darkvision&&n.appendChild(i(`Visione: ${l.senses.darkvision} ft`));let u=null;l.traits&&l.traits.length>0&&(n.appendChild(a("Tratti:",4)),l.traits.forEach(t=>{const o=`trait-${t.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}`,a=t.name,i=document.createElement("details");i.className="race-trait feature-block",i.id=o;const s=document.createElement("summary");s.textContent=t.name,i.appendChild(s);const c=document.createElement("div");c.className="feature-desc",c.textContent=t.description||"",i.appendChild(c);const l=t.choices||t.variant_feature_choices;l&&l.forEach((t,n)=>{const o=t.options||t.selection||[],s=e[a]?.[n]||"",c=document.createElement("label");c.textContent=(t.name||"Scegli")+": ";const l=document.createElement("select");l.dataset.feature=a,l.dataset.index=n;const r=document.createElement("option");r.value="",r.textContent="Seleziona...",l.appendChild(r),o.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s===e&&(t.selected=!0),l.appendChild(t)}),c.appendChild(l),i.appendChild(c)}),t.name.toLowerCase().includes("cantrip")&&(u=i),n.appendChild(i)}));const p=H(l,"race");S(p);const h={Languages:/language/i,"Skill Proficiency":/skill/i,"Tool Proficiency":/tool/i};if(p.forEach((t,o)=>{const a=w[t.name]||t.name;let i=null;const s=h[t.name];if(s&&(i=Array.from(n.querySelectorAll("details")).find(e=>s.test(e.querySelector("summary")?.textContent||""))),!i){i=document.createElement("details"),i.className="race-trait feature-block",i.id=`race-extra-${o}`;const e=document.createElement("summary");e.textContent=t.name,i.appendChild(e),n.appendChild(i)}if(t.description&&!i.querySelector(".feature-desc")){const e=document.createElement("div");e.className="feature-desc",e.textContent=t.description,i.appendChild(e)}const c=t.selection||[],l=t.count||1;for(let n=0;n<l;n++){const o=e[a]?.[n]||"",s=document.createElement("label");s.textContent=`${t.name}${l>1?" "+(n+1):""}: `;const r=document.createElement("select");r.dataset.feature=a,r.dataset.index=n;const d=document.createElement("option");d.value="",d.textContent="Seleziona...",r.appendChild(d),c.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o===e&&(t.selected=!0),r.appendChild(t)}),s.appendChild(r),i.appendChild(s)}}),l.variant_feature_choices){const e=document.createElement("details");e.className="race-trait feature-block needs-selection incomplete",e.id="variantFeatureTrait";const t=document.createElement("summary");t.textContent="Variant Feature",e.appendChild(t);const o=document.createElement("div");o.id="variantFeatureSelectionContainer",e.appendChild(o);const a=document.createElement("div");a.id="variantExtraContainer",e.appendChild(a),n.appendChild(e)}const f=document.createElement("details");f.className="race-trait feature-block needs-selection incomplete hidden",f.id="ancestryTrait";const E=document.createElement("summary");E.textContent="Ancestry",f.appendChild(E);const v=document.createElement("div");v.id="ancestrySelectionContainer",f.appendChild(v),n.appendChild(f);const C=function(e){let t="";return e&&Array.isArray(e)?(e.forEach(e=>{e.entries&&Array.isArray(e.entries)&&e.entries.forEach(n=>{if("object"==typeof n&&"table"===n.type){if(t+='<div class="table-container" style="margin-top:1em; margin-bottom:1em;">',n.caption&&(t+=`<p><strong>${n.caption}</strong></p>`),t+='<table border="1" style="width:100%; border-collapse: collapse;">',n.colLabels&&Array.isArray(n.colLabels)&&(t+="<thead><tr>",n.colLabels.forEach(e=>{t+=`<th style="padding: 0.5em; text-align: center;">${e}</th>`}),t+="</tr></thead>"),n.rows&&Array.isArray(n.rows)&&(t+="<tbody>",n.rows.forEach(e=>{t+="<tr>",e.forEach(e=>{t+=`<td style="padding: 0.5em; text-align: center;">${e}</td>`}),t+="</tr>"}),t+="</tbody>"),t+="</table>",e.name&&e.name.toLowerCase().includes("ancestry")){let e='<option value="">Seleziona...</option>';n.rows.forEach(t=>{const n=JSON.stringify(t),o=`${t[0]} (${t[1]})`;e+=`<option value='${n}'>${o}</option>`}),t+=`<p><strong>Seleziona Ancestry:</strong>\n                      <select id="ancestrySelect">${e}</select>\n                     </p>`}t+="</div>"}})}),t):t}(l.rawEntries);if(C){const e=document.createElement("div");e.appendChild(document.createRange().createContextualFragment(C)),n.appendChild(e)}await function(e,t){return new Promise(n=>{const o="string"==typeof t?document.getElementById(t):t;if(!o||!e.spellcasting)return void n();if(console.log(`🔍 JSON Spellcasting per ${e.name}:`,e.spellcasting),e.spellcasting.fixed_spell){const t=document.createElement("p");t.innerHTML=`<strong>✨ Assigned spell:</strong> ${e.spellcasting.fixed_spell}`,o.appendChild(t)}const a=()=>{if(e.spellcasting.ability_choices&&Array.isArray(e.spellcasting.ability_choices)&&(console.log(`🧙‍♂️ Checking casting ability for ${e.name}:`,e.spellcasting.ability_choices),e.spellcasting.ability_choices.length>1)){const t=e.spellcasting.ability_choices.map(e=>`<option value="${e.toUpperCase()}">${e.toUpperCase()}</option>`).join(""),n=document.createElement("div");n.innerHTML=`\n            <p><strong>🧠 Select the casting ability:</strong></p>\n            <select id="castingAbility">\n              <option value="">Select...</option>${t}\n            </select>`,o.appendChild(n)}n()};if(e.spellcasting.spell_choices)if("fixed_list"===e.spellcasting.spell_choices.type){const t=e.spellcasting.spell_choices.options.map(e=>`<option value="${e}">${e}</option>`).join(""),n=document.createElement("div");n.innerHTML=`\n          <p><strong>🔮 Choose a spell:</strong></p>\n          <select id="spellSelection">\n            <option value="">Select...</option>${t}\n          </select>`,o.appendChild(n),a()}else if("filter"===e.spellcasting.spell_choices.type){const t=e.spellcasting.spell_choices.filter.split("|"),n=t.find(e=>e.startsWith("level="))?.split("=")[1],i=t.find(e=>e.startsWith("class="))?.split("=")[1];if(n&&i)r(e=>{const t=(c().Cantrips||[]).map(e=>e.toLowerCase()),s=e.filter(e=>parseInt(e.level)===parseInt(n)&&e.spell_list.includes(i)&&!t.includes(e.name.toLowerCase())).map(e=>`<option value="${e.name}">${e.name}</option>`).join(""),l=document.createElement("div");l.innerHTML=s?`\n                <p><strong>🔮 Choose a ${i} Cantrip:</strong></p>\n                <select id="spellSelection">\n                  <option value="">Select...</option>${s}\n                </select>`:`<p><strong>⚠️ No Cantrip available for ${i}.</strong></p>`,o.appendChild(l),a()});else{const e=document.createElement("p");e.innerHTML="<strong>⚠️ Error: Spell filter is not valid for this race.</strong>",o.appendChild(e),a()}}else a();else a()})}(l,u),function(e){if(!e.variant_feature_choices)return;const t=document.getElementById("variantFeatureSelectionContainer");if(!t)return;let n='<p><strong>Scegli una Variant Feature:</strong></p><select id="variantFeatureChoice">\n                <option value="">Seleziona...</option>';e.variant_feature_choices.forEach(e=>{n+=`<option value="${e.name}">${e.name}</option>`}),n+="</select>",t.innerHTML=n,document.getElementById("variantFeatureChoice").addEventListener("change",y)}(l),function(e,t){if(e.variant_feature_choices&&e.variant_feature_choices.length>0){const n=e.variant_feature_choices.filter(e=>e.name.toLowerCase().includes("ancestry"));if(n.length>0){let e='<h4>Seleziona Ancestry</h4>\n                  <select id="ancestrySelection">\n                    <option value="">Seleziona...</option>';n.forEach(t=>{e+=`<option value="${t.name}">${t.name}</option>`}),e+="</select>";const o=document.getElementById(t);o&&(o.innerHTML=e)}}else{const e=document.getElementById(t);e&&(e.innerHTML="")}}(l,"ancestrySelectionContainer"),_(n),n.classList.add("accordion"),n.style.display="block",F(n,O),M(n);const k=document.getElementById("ancestryTrait");if(k){const e=document.getElementById("ancestrySelectionContainer");e&&""!==e.innerHTML.trim()&&k.classList.remove("hidden")}const b=document.getElementById("variantFeatureChoice");b&&(b.addEventListener("change",()=>{c()["Variant Feature"]=[b.value],y(),P("variantFeatureTrait")}),P("variantFeatureTrait"));const L=document.getElementById("ancestrySelection");L&&(L.addEventListener("change",()=>{c().Ancestry=[L.value],P("ancestryTrait")}),P("ancestryTrait")),U(),window.currentRaceData=l}catch(e){o(`Errore caricando i tratti della razza: ${e}`)}}I&&x&&(I.addEventListener("click",()=>{const e=k();e>0&&(b(e-1),T())}),x.addEventListener("click",()=>{const e=k();e<C().length-1&&(b(e+1),T())})),$&&$.addEventListener("click",()=>{const e=document.getElementById("raceExtrasModal");e&&e.classList.add("hidden"),sessionStorage.removeItem("popupOpened"),l()}),A();const D=document.getElementById("raceSelect");async function z(){const e=document.getElementById("classFeatures"),t=window.currentClassData;if(!e)return;if(!t)return e.textContent="",void e.appendChild(i("Seleziona una classe per vedere i tratti."));const n=c(),o=parseInt(document.getElementById("levelSelect")?.value)||1,s=document.getElementById("subclassSelect")?.value||"";e.textContent="",e.appendChild(a(t.name,3)),t.description&&e.appendChild(i(t.description));const l=[],r=t.tool_proficiencies&&!Array.isArray(t.tool_proficiencies)?t.tool_proficiencies:null;if(t.weapon_proficiencies&&l.push(`Weapon Training: ${t.weapon_proficiencies.join(", ")}`),t.armor_proficiencies&&l.push(`Armor Training: ${t.armor_proficiencies.join(", ")}`),t.skill_proficiencies&&t.skill_proficiencies.choose&&l.push(`Skill Proficiencies: Choose ${t.skill_proficiencies.choose} from ${t.skill_proficiencies.options.join(", ")}`),t.multiclassing&&t.multiclassing.prerequisites){const e=Object.entries(t.multiclassing.prerequisites).map(([e,t])=>`${e} ${t}`).join(", ");l.push(`Multiclassing Prerequisite: ${e}`)}if(l.length){const t=document.createElement("details");t.className="feature-block";const n=document.createElement("summary");n.textContent="Proficiencies",t.appendChild(n),l.forEach(e=>t.appendChild(i(e))),e.appendChild(t)}if(t.subclasses&&t.subclasses.length>0){const n=document.createElement("details");n.className="feature-block",n.id="subclassTrait";const o=document.createElement("summary");o.textContent="Sottoclasse",n.appendChild(o);const a=document.createElement("select");a.id="subclassSelect",a.className="form-control";const i=document.createElement("option");i.value="",i.textContent="Seleziona una sottoclasse",a.appendChild(i),t.subclasses.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,s===e.name&&(t.selected=!0),a.appendChild(t)}),n.appendChild(a),e.appendChild(n)}let d=null;if(s)try{const t=function(e){let t=e.toLowerCase();t.startsWith("college of ")?t="college_of_"+t.slice(11):t.startsWith("circle of the ")?t="circle_of_the_"+t.slice(14):t.startsWith("circle of ")?t="circle_of_"+t.slice(10):(t=t.replace(/^(path|oath|way|school) of the /,"").replace(/^(path|oath|way|school) of /,"").replace(/^the /,""),t.endsWith(" domain")&&(t=t.slice(0,-7)));let n=t.replace(/ /g,"_")+".json";return"wild_magic.json"===n&&"Barbarian"===window.currentClassData?.name&&(n="barbarian_wild_magic.json"),n}(s),n=await fetch(`data/subclasses/${t}`);if(!n.ok)throw new Error("Network response was not ok");d=await n.json(),d.description&&e.appendChild(i(d.description))}catch(t){e.appendChild(i("Dettagli della sottoclasse non disponibili."))}else e.appendChild(i("Seleziona una sottoclasse per vedere i tratti."));const u={};t.features_by_level&&Object.entries(t.features_by_level).forEach(([e,t])=>{u[e]=[...t]}),d?.features_by_level&&Object.entries(d.features_by_level).forEach(([e,t])=>{u[e]||(u[e]=[]),u[e].push(...t)});Object.keys(u).sort((e,t)=>e-t).forEach(t=>{parseInt(t)<=o&&(e.appendChild(a(`Livello ${t}`,4)),u[t].forEach((o,a)=>{if("string"==typeof o){const t=document.createElement("details");t.className="feature-block";const n=document.createElement("summary");n.textContent=o,t.appendChild(n),e.appendChild(t)}else{const i=document.createElement("details");i.className="feature-block",i.id=`class-feature-${t}-${a}`;const s=document.createElement("summary");if(s.textContent=o.name,i.appendChild(s),o.description){const e=document.createElement("div");e.className="feature-desc",e.textContent=o.description,i.appendChild(e)}const c=o.choices||o.variant_feature_choices;c&&c.forEach((e,t)=>{const a=e.options||e.selection||[],s=n[o.name]?.[t]||"",c=document.createElement("label");c.textContent=(e.name||"Scegli")+": ";const l=document.createElement("select");l.dataset.feature=o.name,l.dataset.index=t;const r=document.createElement("option");r.value="",r.textContent="Seleziona...",l.appendChild(r),a.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,s===e&&(t.selected=!0),l.appendChild(t)}),c.appendChild(l),i.appendChild(c)}),e.appendChild(i)}}))});const m=[...t.choices||[],...d?.choices||[]];r&&!m.some(e=>"Tool Proficiency"===e.name)&&m.push({level:1,name:"Tool Proficiency",description:`Choose ${r.choose} from the class options`,count:r.choose,selection:r.options}),t.skill_proficiencies&&!m.some(e=>"Skill Proficiency"===e.name)&&m.push({level:1,name:"Skill Proficiency",description:`Choose ${t.skill_proficiencies.choose} from the class skill list`,count:t.skill_proficiencies.choose,selection:t.skill_proficiencies.options});const p=H({choices:m},"class",o);S(p);const g={Languages:/Proficiencies/i,"Skill Proficiency":/Proficiencies/i,"Tool Proficiency":/Proficiencies/i};p.forEach(t=>{const o=w[t.name]||t.name,a=Array.from(e.querySelectorAll("details"));let i=a.find(e=>{const n=e.querySelector("summary")?.textContent||"";return n===t.name||n===o});if(!i){const e=g[t.name]||g[o];e&&(i=a.find(t=>e.test(t.querySelector("summary")?.textContent||"")))}if(!i){i=document.createElement("details"),i.className="feature-block";const n=document.createElement("summary");n.textContent=t.name,i.appendChild(n),e.appendChild(i)}if(t.description&&!i.querySelector(".feature-desc")){const e=document.createElement("div");e.className="feature-desc",e.textContent=t.description,i.appendChild(e)}const s=t.options||t.selection||[],c=[];for(let e=0;e<(t.count||1);e++){const a=t.selected?.[e]||n[o]?.[e]||"",l=document.createElement("label");l.textContent=`${t.name}${t.count>1?" "+(e+1):""}: `;const r=document.createElement("select");r.dataset.feature=o,r.dataset.index=e,r.dataset.options=JSON.stringify(s);const d=document.createElement("option");d.value="",d.textContent="Seleziona...",r.appendChild(d),s.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),a&&(r.value=a),l.appendChild(r),i.appendChild(l),c.push(r)}const l=()=>{const e=new Set(c.map(e=>e.value).filter(Boolean));c.forEach(t=>{const n=JSON.parse(t.dataset.options),o=t.value;t.innerHTML='<option value="">Seleziona...</option>'+n.map(t=>`<option value="${t}" ${e.has(t)&&t!==o?"disabled":""}>${t}</option>`).join(""),t.value=o})};c.forEach(e=>e.addEventListener("change",l)),l()}),_(e),e.classList.add("accordion"),F(e,O),M(e);const h=document.getElementById("subclassSelect");h&&h.addEventListener("change",z)}D&&D.addEventListener("change",()=>{console.log("🔄 Razza cambiata, reset delle selezioni extra..."),s={},l(),N=c(),document.getElementById("languageSelection").innerHTML="",document.getElementById("skillSelectionContainer").innerHTML="",document.getElementById("toolSelectionContainer").innerHTML="",j(),document.getElementById("confirmRaceSelection").style.display="inline-block"});let N=c();function P(e){const t=document.getElementById(e);if(!t)return;const n=[...t.querySelectorAll("select")].some(e=>!e.value);t.classList.toggle("incomplete",n)}function q(e){const t=new Set,n=[];if((N[{skills:"Skill Proficiency",tools:"Tool Proficiency",languages:"Languages"}[e]]||[]).filter(e=>e).forEach(e=>{const o=e.toLowerCase();t.has(o)||(t.add(o),n.push(e))}),window.backgroundData){const o={skills:"skills",tools:"tools",languages:"languages"};(window.backgroundData[o[e]]||[]).forEach(e=>{const o=e.toLowerCase();t.has(o)||(t.add(o),n.push(e))})}if(window.currentClassData)if("tools"===e){const e=window.currentClassData.tool_proficiencies;Array.isArray(e)?e.forEach(e=>{const o=e.toLowerCase();o.includes("of your choice")||o.includes(" or ")||t.has(o)||(t.add(o),n.push(e))}):e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>{const o=e.toLowerCase();t.has(o)||(t.add(o),n.push(e))})}else if("skills"===e){const e=window.currentClassData.skill_proficiencies;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>{const o=e.toLowerCase();t.has(o)||(t.add(o),n.push(e))})}else if("languages"===e){const e=window.currentClassData.language_proficiencies;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>{const o=e.toLowerCase();t.has(o)||(t.add(o),n.push(e))})}return n}function H(e,t,n=1){const o=[],a=new Set(q("languages").map(e=>e.toLowerCase())),i=new Set(q("skills").map(e=>e.toLowerCase())),s=new Set(q("tools").map(e=>e.toLowerCase()));if("race"===t){if(e.languages&&(e.languages.fixed.length>0||e.languages.choice>0)){const t=new Set(e.languages.fixed.map(e=>e.toLowerCase())),n=u.filter(e=>!t.has(e.toLowerCase())),{options:i,note:s}=p("languages",n,a),c=e.languages.fixed.length?`<strong>Lingue Concesse:</strong> ${e.languages.fixed.join(", ")}`:"";o.push({name:"Languages",description:c+s,selection:i,count:e.languages.choice})}if(e.skill_choices){const{options:t,note:n}=p("skills",e.skill_choices.options,i);t.length>0&&o.push({name:"Skill Proficiency",description:"Choose skill proficiencies."+n,selection:t,count:e.skill_choices.number})}if(e.tool_choices){const{options:t,note:n}=p("tools",e.tool_choices.options,s);t.length>0&&o.push({name:"Tool Proficiency",description:"Choose a tool proficiency."+n,selection:t,count:1})}}else if("class"===t){(e.choices||[]).forEach(e=>{if(!e.level||parseInt(e.level)<=n){const t=w[e.name]||e.name,n=(N[t]||[]).filter(e=>e);let c=e.selection||e.options||[],l="";const r={Languages:{type:"languages",taken:a},"Skill Proficiency":{type:"skills",taken:i},"Tool Proficiency":{type:"tools",taken:s}}[t];if(r){const e=p(r.type,c,r.taken,n);c=e.options,l=e.note}const d=l?(e.description||"")+l:e.description;o.push({...e,selection:c,description:d,selected:n})}})}return o}function F(e,t){if(!e)return;e.querySelectorAll(".feature-block").forEach(e=>{const n=e.querySelectorAll("select");if(0===n.length)return;e.classList.add("user-choice");const o=()=>{const t=Array.from(n).some(e=>!e.value);e.classList.toggle("needs-selection",t)};o(),n.forEach(e=>{e.addEventListener("change",()=>{t&&t(e),o()})})})}function O(e){const t=e.dataset.feature,n=e.dataset.index||0;t&&(N[t]||(N[t]=[]),N[t][n]=e.value||void 0,l())}function R(){const e=document.getElementById("finalRecap");if(!e)return;N=c();const t=document.getElementById("userName")?.value||"",n=document.getElementById("characterName")?.value||"",o=document.getElementById("classSelect").selectedOptions[0]?.text||"",a=document.getElementById("subclassSelect").selectedOptions[0]?.text||"",i=document.getElementById("raceSelect").selectedOptions[0]?.text||"",s=document.getElementById("levelSelect")?.value||"",l=document.getElementById("origin")?.value||"",r=document.getElementById("age")?.value||"",d=window.backgroundData&&window.backgroundData.languages||[],u=window.backgroundData&&window.backgroundData.tools||[],m=N.Languages||[],p=N["Tool Proficiency"]||[],g=[...new Set([...d,...m])],h=[...new Set([...u,...p])],f=N.equipment||{},y=[...f.standard||[],...f.class||[],...f.upgrades||[]];let E="";E+=`<p><strong>Nome Utente:</strong> ${t}</p>`,E+=`<p><strong>Nome PG:</strong> ${n}</p>`,E+=`<p><strong>Classe:</strong> ${o}${a?` (${a})`:""}</p>`,E+=`<p><strong>Razza:</strong> ${i}</p>`,E+=`<p><strong>Livello:</strong> ${s}</p>`,E+=`<p><strong>Provenienza:</strong> ${l}</p>`,E+=`<p><strong>Età:</strong> ${r}</p>`,E+=`<p><strong>Lingue:</strong> ${g.join(", ")}</p>`,E+=`<p><strong>Strumenti:</strong> ${h.join(", ")}</p>`,E+=`<p><strong>Equip:</strong> ${y.join(", ")}</p>`,e.innerHTML=E}function J(){let e=null;const t=document.getElementById("ancestrySelect");if(t&&t.value)try{e=JSON.parse(t.value)}catch(e){console.error("Errore nel parsing della Chromatic Ancestry scelta",e)}const n=document.getElementById("toolChoice0")?document.getElementById("toolChoice0").value:null,o=document.getElementById("variantFeatureChoice")?document.getElementById("variantFeatureChoice").value:null,a={},i=document.querySelectorAll(".variantSkillChoice");i.length>0&&(a.skills=[],i.forEach(e=>{e.value&&a.skills.push(e.value)}));const s=document.getElementById("variantSpellChoice");s&&s.value&&(a.spell=s.value);const c=window.backgroundData&&window.backgroundData.languages||[],l=[...new Set([...N.Languages||[],...c])],r={user_name:document.getElementById("userName")?.value||"",name:document.getElementById("characterName").value||"Senza Nome",origin:document.getElementById("origin")?.value||"",age:document.getElementById("age")?.value||"",level:document.getElementById("levelSelect").value||"1",race:document.getElementById("raceSelect").selectedOptions[0]?.text||"Nessuna",class:document.getElementById("classSelect").selectedOptions[0]?.text||"Nessuna",subclass:document.getElementById("subclassSelect").selectedOptions[0]?.text||"Nessuna",background:window.backgroundData?window.backgroundData.name:"Nessuno",stats:{strength:document.getElementById("strFinalScore").textContent,dexterity:document.getElementById("dexFinalScore").textContent,constitution:document.getElementById("conFinalScore").textContent,intelligence:document.getElementById("intFinalScore").textContent,wisdom:document.getElementById("wisFinalScore").textContent,charisma:document.getElementById("chaFinalScore").textContent},racial_bonus:{strength:document.getElementById("strRaceModifier").textContent,dexterity:document.getElementById("dexRaceModifier").textContent,constitution:document.getElementById("conRaceModifier").textContent,intelligence:document.getElementById("intRaceModifier").textContent,wisdom:document.getElementById("wisRaceModifier").textContent,charisma:document.getElementById("chaRaceModifier").textContent},background_proficiencies:window.backgroundData?{skills:window.backgroundData.skills||[],tools:window.backgroundData.tools||[],languages:window.backgroundData.languages||[]}:{skills:[],tools:[],languages:[]},background_feat:window.backgroundData&&window.backgroundData.feat||"",equipment:N.equipment||{standard:[],class:[],upgrades:[]},languages:{selected:l},selections:N,chromatic_ancestry:e,tool_proficiency:n,variant_feature:o,variant_extra:a};console.log("✅ JSON finale generato:"),console.log(JSON.stringify(r,null,2));!function(e,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o)}(r.name.replace(/[^a-z0-9]/gi,"_").toLowerCase()+"_character.json",r),alert("JSON generato e scaricato!")}A();var W=27;function V(){const e=parseInt(document.getElementById("levelSelect")?.value)||1;["str","dex","con","int","wis","cha"].forEach(t=>{const n=parseInt(document.getElementById(`${t}Points`).textContent),o=parseInt(document.getElementById(`${t}RaceModifier`).textContent),a=document.getElementById(`${t}BackgroundTalent`),i=n+o+(a&&parseInt(a.value)||0),s=document.getElementById(`${t}FinalScore`);1===e&&i>17?(s.textContent="Errore",s.style.color="red"):(s.textContent=i,s.style.color="")}),console.log("🔄 Punteggi Finali aggiornati!")}function U(){document.getElementById("racialBonus1").value="",document.getElementById("racialBonus2").value="",document.getElementById("racialBonus3").value="";["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent="0")}),V()}window.applyRacialBonuses=function(){console.log("⚡ applyRacialBonuses() chiamata!");const e=document.getElementById("racialBonus1").value,t=document.getElementById("racialBonus2").value,n=document.getElementById("racialBonus3").value;if(!e||!t||!n)return void o("Devi selezionare tutti e tre i bonus razziali!");const a={};[e,t,n].forEach(e=>{a[e]=(a[e]||0)+1});const i=Object.values(a);if(!(i.includes(2)&&i.includes(1)&&2===Object.keys(a).length||i.every(e=>1===e)&&3===Object.keys(a).length))return void o("Puoi assegnare +2 a una caratteristica e +1 a un'altra, oppure +1 a tre diverse!");["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent=a[e]?a[e]:"0")}),console.log("✅ Bonus razziali applicati:",a),V()},window.adjustPoints=function(e,t){const n=document.getElementById(e+"Points");let o=parseInt(n.textContent);"add"===t&&W>0&&o<15?(W-=o>=13?2:1,o++):"subtract"===t&&o>8&&(W+=o>13?2:1,o--),n.textContent=o;const a=document.getElementById("pointsRemaining");a&&(a.textContent=W),V()};let G={},K=null;function Q(e){_(e),e.classList.add("accordion"),M(e)}function X(){["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"BackgroundTalent");t&&(t.value=0)})}function Y(){X(),K&&K.fixedAbilities&&K.fixedAbilities.forEach(e=>{const t=Object.keys(e)[0],n=e[t],o=document.getElementById(t+"BackgroundTalent");o&&(o.value=n)});document.querySelectorAll(".featAbilityChoice").forEach(e=>{if(e.value){const t=parseInt(e.dataset.amount||"1"),n=document.getElementById(e.value+"BackgroundTalent");n&&(n.value=t)}}),updateFinalScores()}document.addEventListener("DOMContentLoaded",async()=>{if(document.getElementById("step4")){window.backgroundData={name:"",skills:[],tools:[],languages:[],feat:""},t("data/backgrounds.json","backgroundSelect","backgrounds");try{const e=await fetch("data/feats.json");if(!e.ok)throw new Error("Failed to load feats");const t=await e.json();G=t.feats||{}}catch(e){console.error("Errore caricando i talenti:",e)}document.getElementById("backgroundSelect").addEventListener("change",async e=>{const t=e.target.value;if(t)try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();backgroundData.name=n.name;const o=document.getElementById("backgroundSkills");o.innerHTML="";const a=document.createElement("details");a.className="feature-block",a.innerHTML="<summary>Abilità</summary>",backgroundData.skills=Array.isArray(n.skills)?n.skills.slice():[];const i=()=>{const e=a.querySelector(".duplicate-skill-choices");e&&e.remove();const t=new Set(q("skills")),n=backgroundData.skills.filter(e=>t.has(e));if(0===n.length)return a.classList.remove("needs-selection","incomplete"),void F(o);const i=backgroundData.skills.filter(e=>!t.has(e)),s=m.filter(e=>!t.has(e)&&!i.includes(e)),c=document.createElement("div");c.className="duplicate-skill-choices";const l=document.createElement("p");l.innerHTML="<strong>Abilità duplicate, scegli sostituti:</strong>",c.appendChild(l);h(c,n.length,s,"duplicateSkillChoice",()=>{const e=Array.from(c.querySelectorAll(".duplicateSkillChoice")).map(e=>e.value).filter(Boolean);backgroundData.skills=i.concat(e),a.classList.toggle("incomplete",e.length<n.length)}),a.appendChild(c),a.classList.add("needs-selection","incomplete"),F(o)};if(backgroundData.skills.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Abilità:</strong> ${backgroundData.skills.join(", ")}`,a.appendChild(e)}if(n.skillChoices){const e=n.skillChoices.choose||0,t=new Set(q("skills"));let o=(n.skillChoices.options||[]).filter(e=>!t.has(e)),s="";0===o.length&&(o=m.filter(e=>!t.has(e)),s=" (tutte le abilità disponibili)");const c=document.createElement("p");c.innerHTML=`<strong>Scegli ${e} abilità${s}:</strong>`,a.appendChild(c),h(a,e,o,"backgroundSkillChoice",()=>{const e=Array.from(document.querySelectorAll(".backgroundSkillChoice")).map(e=>e.value).filter(Boolean);backgroundData.skills=(n.skills||[]).concat(e),i()})}o.appendChild(a),i(),Q(o);const s=document.getElementById("backgroundTools");s.innerHTML="";const c=document.createElement("details");if(c.className="feature-block",c.innerHTML="<summary>Strumenti</summary>",backgroundData.tools=Array.isArray(n.tools)?n.tools.slice():[],Array.isArray(n.tools)&&n.tools.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Strumenti:</strong> ${n.tools.join(", ")}`,c.appendChild(e)}const l=()=>{const e=Array.from(document.querySelectorAll(".backgroundToolChoice")).map(e=>e.value).filter(Boolean),t=Array.isArray(n.tools)?n.tools.slice():[];backgroundData.tools=t.concat(e)},r=new Set(q("tools"));if(n.tools&&n.tools.choose){const e=n.tools.choose;let t=(n.tools.options||[]).filter(e=>!r.has(e)),o="";0===t.length&&(t=d.filter(e=>!r.has(e)),o=" (tutti gli strumenti disponibili)");const a=document.createElement("p");a.innerHTML=`<strong>Scegli ${e} strumento${o}:</strong>`,c.appendChild(a),h(c,e,t,"backgroundToolChoice",l)}if(n.toolChoices){const e=n.toolChoices.choose||0;let t=(n.toolChoices.options||[]).filter(e=>!r.has(e)),o="";0===t.length&&(t=d.filter(e=>!r.has(e)),o=" (tutti gli strumenti disponibili)");const a=document.createElement("p");a.innerHTML=`<strong>Scegli ${e} strumento${o}:</strong>`,c.appendChild(a),h(c,e,t,"backgroundToolChoice",l)}s.appendChild(c),F(s),Q(s);const p=document.getElementById("backgroundLanguages");p.innerHTML="";const g=document.createElement("details");if(g.className="feature-block",g.innerHTML="<summary>Linguaggi</summary>",backgroundData.languages=Array.isArray(n.languages)?n.languages.slice():[],Array.isArray(n.languages)&&n.languages.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Linguaggi:</strong> ${n.languages.join(", ")}`,g.appendChild(e),p.appendChild(g),F(p),Q(p)}else if(n.languages&&n.languages.choose){const e=n.languages.choose,t=t=>{const n=new Set(q("languages"));let o=(t||[]).filter(e=>!n.has(e)),a="";0===o.length&&(o=u.filter(e=>!n.has(e)),a=" (tutte le lingue disponibili)");const i=document.createElement("p");i.innerHTML=`<strong>Scegli ${e} linguaggi${a}:</strong>`,g.appendChild(i),h(g,e,o,"backgroundLanguageChoice",()=>{const e=Array.from(document.querySelectorAll(".backgroundLanguageChoice")).map(e=>e.value).filter(Boolean);backgroundData.languages=e}),p.appendChild(g),F(p),Q(p)};n.languages.any?t(u):t(n.languages.options||[])}else p.appendChild(g),F(p),Q(p);const f=document.getElementById("backgroundFeat");f.innerHTML="",backgroundData.feat="",K=null;const y=document.createElement("details");if(y.className="feature-block",y.innerHTML="<summary>Talento</summary>",Array.isArray(n.featOptions)&&n.featOptions.length>0){const e=document.createElement("label");e.htmlFor="backgroundFeatSelect",e.textContent="Feat:";const t=document.createElement("select");t.id="backgroundFeatSelect",t.innerHTML='<option value="">Seleziona un talento</option>'+n.featOptions.map(e=>`<option value="${e}">${e}</option>`).join("");const o=document.createElement("div");o.id="featAbilityChoices",t.addEventListener("change",async()=>{if(K=null,o.innerHTML="",backgroundData.feat=t.value||"",X(),t.value&&G[t.value])try{const e=await fetch(G[t.value]);if(!e.ok)throw new Error("Failed to load feat");const n=await e.json(),a=[];n.ability&&n.ability.forEach(e=>{if(e.choose){const t=document.createElement("select");t.className="featAbilityChoice",t.dataset.amount=e.choose.amount||1,t.innerHTML='<option value="">Seleziona caratteristica</option>'+e.choose.from.map(e=>`<option value="${e}">${e.toUpperCase()}</option>`).join(""),t.addEventListener("change",Y),o.appendChild(t)}else a.push(e)}),K={fixedAbilities:a},Y()}catch(e){console.error("Errore caricando il talento:",e)}else updateFinalScores()}),y.appendChild(e),y.appendChild(t),y.appendChild(o)}f.appendChild(y),F(f),Q(f)}catch(e){handleError(`Errore caricando il background: ${e}`)}})}});let Z=null;function ee(){const e=document.getElementById("classSelect");return e&&e.selectedOptions.length?e.selectedOptions[0].text.trim().normalize("NFC"):""}function te(){if(!Z)return;const e=c().equipment||{class:[],upgrades:[]},t=ee(),n=parseInt(document.getElementById("levelSelect").value||"1",10),o=document.getElementById("equipmentSelections");if(!o)return;o.innerHTML="";const a=document.createElement("details");a.className="feature-block",a.innerHTML=`<summary>Equipaggiamento Standard</summary><ul>${Z.standard.map(e=>`<li>${e}</li>`).join("")}</ul>`,o.appendChild(a);const i=Z.classes[t];if(i){if(Array.isArray(i.fixed)&&i.fixed.length>0){const e=document.createElement("details");e.className="feature-block",e.innerHTML=`<summary>Equipaggiamento fisso</summary><p>${i.fixed.join(", ")}</p>`,o.appendChild(e)}Array.isArray(i.choices)&&i.choices.forEach((t,n)=>{const a=document.createElement("details");a.className="feature-block needs-selection incomplete",a.innerHTML=`<summary>${t.label||"Scegli"}</summary>`,t.options.forEach((o,i)=>{const s=`equipChoice_${n}_${i}`,c=document.createElement("input");c.type="checkbox"===t.type?"checkbox":"radio",c.name=`equipChoice_${n}`,c.id=s,c.value=o.value||o,e.class&&e.class.includes(c.value)&&(c.checked=!0);const l=document.createElement("label");l.htmlFor=s,l.textContent=o.label||o,a.appendChild(c),a.appendChild(l),a.appendChild(document.createElement("br"))}),o.appendChild(a)})}else{const e=document.createElement("p");e.textContent="Nessun equipaggiamento specifico per questa classe.",o.appendChild(e)}if(Z.upgrades&&n>=(Z.upgrades.minLevel||0)){const t=Z.upgrades,n=document.createElement("details");if(n.className="feature-block",n.innerHTML="<summary>Opzioni Avanzate</summary>",Array.isArray(t.armor)){const o=document.createElement("p");o.innerHTML="<strong>Armatura:</strong>",n.appendChild(o),t.armor.forEach((t,o)=>{const a=`upgradeArmor_${o}`,i=document.createElement("input");i.type="radio",i.name="upgradeArmor",i.id=a,i.value=t,e.upgrades&&e.upgrades.includes(i.value)&&(i.checked=!0);const s=document.createElement("label");s.htmlFor=a,s.textContent=t,n.appendChild(i),n.appendChild(s),n.appendChild(document.createElement("br"))})}if(t.weapon){const o="upgradeWeapon",a=document.createElement("input");a.type="checkbox",a.id=o,a.value=t.weapon,e.upgrades&&e.upgrades.includes(a.value)&&(a.checked=!0);const i=document.createElement("label");i.htmlFor=o,i.textContent=t.weapon,n.appendChild(a),n.appendChild(i)}o.appendChild(n)}_(o),o.classList.add("accordion"),M(o),o.querySelectorAll(".accordion-item.needs-selection").forEach(e=>{const t=()=>{const t=e.querySelectorAll("input:checked").length>0;e.classList.toggle("incomplete",!t)};e.querySelectorAll("input").forEach(e=>e.addEventListener("change",t)),t(),e.querySelectorAll("input:checked").forEach(e=>e.dispatchEvent(new Event("change")))})}document.addEventListener("DOMContentLoaded",async()=>{if(!document.getElementById("step5"))return;try{const e=await fetch("data/equipment.json");if(!e.ok)throw new Error("Failed to load equipment data");const t=await e.json();Z=t,te();const n=document.getElementById("classSelect"),o=document.getElementById("levelSelect");n&&n.addEventListener("change",te),o&&o.addEventListener("change",te)}catch(e){console.error("Error loading equipment:",e)}const e=document.getElementById("confirmEquipment"),t=document.getElementById("equipmentSelections");e&&t&&e.addEventListener("click",()=>{const e=ee(),n=Z.classes[e]||{fixed:[]},o=[];Array.isArray(n.fixed)&&o.push(...n.fixed);const a=[];t.querySelectorAll("input:checked").forEach(e=>{e.name&&e.name.startsWith("equipChoice_")?o.push(e.value):a.push(e.value)});c().equipment={standard:Z.standard,class:o,upgrades:a},l()})}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("step7");e&&(e.innerHTML='\n    <h2>Step 7: Riepilogo ed Esportazione</h2>\n    <div id="finalRecap"></div>\n    <button id="generateJson">Genera JSON</button>\n    \x3c!-- Puoi aggiungere qui anche il pulsante per esportare in PDF --\x3e\n  ')});let ne="",oe="",ae="";async function ie(e,t){oe=t;const n=document.getElementById("raceModal"),o=document.getElementById("raceModalDetails");if(n&&o){try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();o.textContent="",o.appendChild(a(n.name,3))}catch(e){o.textContent="Errore caricando i dettagli della razza."}n.classList.remove("hidden")}}function se(){const e=document.getElementById("raceModal");e&&e.classList.add("hidden")}async function ce(e,t){ae=t;const n=document.getElementById("backgroundModal"),o=document.getElementById("backgroundModalDetails");if(n&&o){try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();o.textContent="",o.appendChild(a(n.name,3)),n.skills&&o.appendChild(i(`Abilità: ${n.skills.join(", ")}`)),n.tools&&n.tools.length&&o.appendChild(i(`Strumenti: ${n.tools.join(", ")}`))}catch(e){o.textContent="Errore caricando i dettagli del background."}n.classList.remove("hidden")}}function le(){const e=document.getElementById("backgroundModal");e&&e.classList.add("hidden")}async function re(e,t){ne=t;const n=document.getElementById("classModal"),o=document.getElementById("classModalDetails");if(n&&o){try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();o.textContent="",o.appendChild(a(n.name,3)),o.appendChild(i(n.description)),o.appendChild(i(`Hit Die: ${n.hit_die}`)),o.appendChild(i(`Saving Throws: ${n.saving_throws.join(", ")}`))}catch(e){o.textContent="Errore caricando i dettagli della classe."}n.classList.remove("hidden")}}function de(){const e=document.getElementById("classModal");e&&e.classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{console.log("✅ Main.js caricato!"),t("data/races.json","raceSelect","races"),t("data/classes.json","classSelect","classes"),n("data/classes.json","classes","classList",re),n("data/races.json","races","raceList",ie),n("data/backgrounds.json","backgrounds","backgroundList",ce),["step1","step2","step3","step4","step5","step6","step7"].forEach((t,n)=>{const o=document.getElementById(`btnStep${n+1}`);o&&o.addEventListener("click",()=>{e(t),"step7"===t&&R()})});const a=document.getElementById("classSelect"),c=document.getElementById("levelSelect");a&&a.addEventListener("change",()=>{s={},l();const e=document.getElementById("confirmClassSelection");e&&(e.style.display="inline-block"),async function(){const e=document.getElementById("classSelect").value,t=document.getElementById("classFeatures");if(!e)return window.currentClassData=null,void(t&&(t.textContent="",t.appendChild(i("Seleziona una classe per vedere i tratti."))));try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const n=await t.json();window.currentClassData=n,z()}catch(e){o(`Errore caricando le sottoclasse: ${e}`)}}()}),c&&c.addEventListener("change",()=>{z()}),["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent="0");const n=document.getElementById(e+"BackgroundTalent");n&&(n.value="0")}),V();const r=(document.querySelectorAll("input, select, textarea").forEach(e=>{if(!e.id)return;const t=localStorage.getItem(e.id);null!==t&&("checkbox"===e.type||"radio"===e.type?e.checked="true"===t:e.value=t)}),localStorage.getItem("currentStep")),d={nameStep:"step1",classStep:"step2",raceStep:"step3",backgroundStep:"step4",equipmentStep:"step5",pointBuyStep:"step6",recapStep:"step7"}[r]||r;e(d||"step1"),"step7"===(d||"step1")&&R(),document.getElementById("raceSelect").addEventListener("change",j),document.getElementById("levelSelect").addEventListener("change",()=>j()),document.getElementById("generateJson").addEventListener("click",J),document.getElementById("closeClassModal").addEventListener("click",de),document.getElementById("closeRaceModal").addEventListener("click",se),document.getElementById("closeBackgroundModal").addEventListener("click",le),document.getElementById("addClassButton").addEventListener("click",()=>{const e=document.getElementById("classSelect");e&&(e.value=ne,e.dispatchEvent(new Event("change"))),de()}),document.getElementById("addRaceButton").addEventListener("click",()=>{const e=document.getElementById("raceSelect");if(e){e.value=oe,j();const t=document.getElementById("confirmRaceSelection");t&&(t.style.display="inline-block")}se()}),document.getElementById("addBackgroundButton").addEventListener("click",()=>{const e=document.getElementById("backgroundSelect");if(e){e.value=ae,e.dispatchEvent(new Event("change"));const t=document.getElementById("confirmBackgroundSelection");t&&(t.style.display="inline-block")}le()}),document.getElementById("confirmClassSelection").addEventListener("click",async()=>{const e=document.getElementById("classSelect"),t=document.getElementById("subclassSelect"),n=parseInt(document.getElementById("levelSelect")?.value)||1;if(!e.value)return void alert("⚠️ Seleziona una classe prima di procedere!");const o=e.selectedOptions[0]?.text||"";if(t&&n>=({Cleric:1,Warlock:1,Sorcerer:1}[o]||3)&&!t.value)return void alert("⚠️ Seleziona una sottoclasse prima di procedere!");await z();const a=document.getElementById("confirmClassSelection");a&&(a.style.display="none")}),document.getElementById("confirmRaceSelection").addEventListener("click",()=>{document.getElementById("raceSelect").value?document.getElementById("confirmRaceSelection").style.display="none":alert("⚠️ Seleziona una razza prima di procedere!")}),document.getElementById("confirmBackgroundSelection").addEventListener("click",()=>{document.getElementById("backgroundSelect").value?document.getElementById("confirmBackgroundSelection").style.display="none":alert("⚠️ Seleziona un background prima di procedere!")})})}();

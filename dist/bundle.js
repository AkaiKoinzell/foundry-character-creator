!function(){"use strict";function e(e){document.querySelectorAll("input, select, textarea").forEach(e=>{e.id&&("checkbox"===e.type||"radio"===e.type?localStorage.setItem(e.id,e.checked):localStorage.setItem(e.id,e.value))});document.querySelectorAll(".step").forEach(t=>{const n=t.id===e;t.classList.toggle("active",n),t.classList.toggle("hidden",!n)}),function(e){const t=document.getElementById("progressBar");if(!t)return;const n=Array.from(document.querySelectorAll(".step")),o=n.findIndex(t=>t.id===e),a=(o+1)/n.length*100;t.style.width=`${a}%`}(e),localStorage.setItem("currentStep",e)}async function t(e,t){try{const o=await fetch(e);if(!o.ok)throw new Error("Network response was not ok");const a=await o.json();if(console.log(`📜 Dati ricevuti da ${e}:`,a),!a.items)return void n(`Chiave items non trovata in ${e}`);!function(e,t){const o=document.getElementById(e);if(!o)return void n(`Elemento #${e} non trovato!`);o.innerHTML='<option value="">Seleziona...</option>',t.forEach(e=>{const t=document.createElement("option");t.value=e.path,t.textContent=e.name,o.appendChild(t)})}(t,Object.entries(a.items).map(([e,t])=>({name:e,path:t})))}catch(t){n(`Errore caricando ${e}: ${t}`)}}function n(e){console.error("❌ "+e),alert("⚠️ "+e)}function o(e,t=3){const n=document.createElement(`h${t}`);return n.textContent=e,n}function a(e){const t=document.createElement("p");return t.textContent=e,t}async function i(e){try{const t=await fetch("data/spells.json");if(!t.ok)throw new Error("Failed to load spells");const n=await t.json();console.log("📖 Spells loaded:",n),e(n)}catch(e){console.error("❌ Error loading spells:",e)}}window.resetForm=function(){if(!confirm("Reset all character data?"))return;localStorage.clear(),document.querySelectorAll("input, select, textarea").forEach(e=>{"checkbox"===e.type||"radio"===e.type?e.checked=!1:"select"===e.tagName.toLowerCase()?e.selectedIndex=0:e.value=""}),document.querySelectorAll(".step").forEach((e,t)=>{const n=0===t;e.classList.toggle("active",n),e.classList.toggle("hidden",!n)});const e=document.getElementById("progressBar");e&&(e.style.width="0%")};const l=["Alchemist's Supplies","Brewer's Supplies","Calligrapher's Tools","Carpenter's Tools","Cartographer's Tools","Cobbler's Tools","Cook's Utensils","Glassblower's Tools","Jeweler's Tools","Leatherworker's Tools","Mason's Tools","Painter's Supplies","Potter's Tools","Smith's Tools","Tinker's Tools","Weaver's Tools","Woodcarver's Tools","Bagpipes","Drum","Dulcimer","Flute","Lute","Lyre","Horn","Pan Flute","Shawm","Viol","Disguise Kit","Forgery Kit","Herbalism Kit","Navigator's Tools","Poisoner's Kit","Thieves' Tools","Dice Set","Dragonchess Set","Playing Card Set","Three-Dragon Ante Set","Vehicle (Land)","Vehicle (Water)"],s=["Common","Dwarvish","Elvish","Giant","Gnomish","Goblin","Halfling","Orc","Abyssal","Celestial","Draconic","Deep Speech","Infernal","Primordial","Sylvan","Undercommon"],c=["Acrobatics","Animal Handling","Arcana","Athletics","Deception","History","Insight","Intimidation","Investigation","Medicine","Nature","Perception","Performance","Persuasion","Religion","Sleight of Hand","Stealth","Survival"];function r(e,t,n,o=[]){const a={languages:s,skills:c,tools:l},i={languages:" (tutte le lingue disponibili)",skills:" (tutte le abilità disponibili)",tools:" (tutti gli strumenti disponibili)"},r=o.map(e=>e.toLowerCase());let d=t.filter(e=>!n.has(e.toLowerCase())||r.includes(e.toLowerCase()));return 0===d.length?(d=(a[e]||[]).filter(e=>!n.has(e.toLowerCase())||r.includes(e.toLowerCase())),{options:d,note:i[e]||""}):{options:d,note:""}}function d(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.entries?d(e.entries):e.items?d(e.items):"").join(" "):""}let u=sessionStorage.getItem("selectedData")?JSON.parse(sessionStorage.getItem("selectedData")):{};function p(){return u}function m(){sessionStorage.setItem("selectedData",JSON.stringify(u))}function g(e,t,n,o,a){const i=[];for(let a=0;a<t;a++){const t=document.createElement("select");t.className=o,t.dataset.options=JSON.stringify(n),e.appendChild(t),i.push(t)}const l=()=>{const e=new Set(i.map(e=>e.value).filter(Boolean));i.forEach(t=>{const n=JSON.parse(t.dataset.options),o=t.value;t.innerHTML='<option value="">Seleziona</option>'+n.map(t=>`<option value="${t}" ${e.has(t)&&t!==o?"disabled":""}>${t}</option>`).join(""),t.value=o}),a&&a()};return i.forEach(e=>e.addEventListener("change",l)),l(),i}function h(e,t,n,o,{featureKey:a,label:i,selectedData:l={},startIndex:s,selectClass:c="",changeHandler:r,getTakenOptions:d={}}={}){if(!o||!Array.isArray(t)||0===t.length)return[];const{taken:u,conflicts:p}=F(e,t,d);if(!p.length)return[];const m=t.filter(e=>!p.includes(e));let g=n.filter(e=>!u.has(e.toLowerCase()));if(0===g.length){const e=m.map(e=>e.toLowerCase());g=n.filter(t=>!e.includes(t.toLowerCase()))}const h=void 0!==s?s:a?o.querySelectorAll(`select[data-feature="${a}"]`).length:0,f=[],y=document.createElement("p");y.innerHTML=`<strong>${i} duplicate, scegli sostituti:</strong>`,o.appendChild(y),p.forEach((e,t)=>{const n=document.createElement("label");n.textContent=`${e}: `;const i=document.createElement("select");a&&(i.dataset.feature=a,i.dataset.index=h+t),c&&(i.className=c);const s=document.createElement("option");s.value="",s.textContent="Seleziona...",i.appendChild(s),g.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,i.appendChild(t)});const r=a&&l[a]?.[h+t]||"";r&&(i.value=r),n.appendChild(i),o.appendChild(n),f.push(i)});const E=()=>{const e=new Set(f.map(e=>e.value).filter(Boolean));f.forEach(t=>{const n=t.value;t.innerHTML='<option value="">Seleziona...</option>'+g.map(t=>`<option value="${t}" ${e.has(t)&&t!==n?"disabled":""}>${t}</option>`).join(""),t.value=n}),r&&r(f.map(e=>e.value))};return f.forEach(e=>e.addEventListener("change",E)),E(),f}const f={"Drow Magic":{type:"none"},"Skill Versatility":{type:"skills",count:2,options:c},Swim:{type:"none"},"Cantrip (Wizard)":{type:"spells",filter:"level=0|class=Wizard"}};function y(){const e=document.getElementById("variantFeatureChoice"),t=document.getElementById("variantExtraContainer");if(!t||!e||!e.value)return;const n=e.value,o=f[n];if(t.innerHTML="",o)if("skills"===o.type){t.innerHTML=`<p><strong>Seleziona ${o.count} skill per ${n}:</strong></p>`;const e=()=>{p()["Variant Feature Skills"]=[...t.querySelectorAll(".variantSkillChoice")].map(e=>e.value).filter(Boolean),m(),z("variantFeatureTrait")};g(t,o.count,o.options,"variantSkillChoice",e)}else"spells"===o.type&&i(e=>{const a=function(e,t){const n=t.split("|");return e.filter(e=>{let t=!0;return n.forEach(n=>{const o=n.split("=");if(2===o.length){const n=o[0].trim().toLowerCase(),a=o[1].trim().toLowerCase();"level"===n?parseInt(e.level)!==parseInt(a)&&(t=!1):"class"===n&&(e.spell_list&&e.spell_list.map(e=>e.toLowerCase()).includes(a)||(t=!1))}}),t})}(e,o.filter);t.innerHTML=a.length?`<p><strong>Seleziona un incantesimo per ${n}:</strong></p>\n            <select id="variantSpellChoice">\n              <option value="">Seleziona...</option>\n              ${a.map(e=>`<option value="${e.name}">${e.name}</option>`).join("")}\n            </select>`:`<p>Nessun incantesimo trovato per il filtro: ${o.filter}</p>`;const i=document.getElementById("variantSpellChoice");i&&(i.addEventListener("change",()=>{p()["Variant Feature Spell"]=[i.value],m(),z("variantFeatureTrait")}),z("variantFeatureTrait"))})}let E=[],C=0;function v(){return E}function S(e){E=e}function k(){return C}function w(e){C=e}const b={Cantrip:"Cantrips",Cantrips:"Cantrips","Skill Proficiency":"Skill Proficiency","Tool Proficiency":"Tool Proficiency","Fighting Style":"Fighting Style","Additional Fighting Style":"Fighting Style","Divine Domain":"Divine Domain",Metamagic:"Metamagic"},L={Cantrips:"Scegli i tuoi cantrip.","Skill Proficiency":"Seleziona le competenze nelle abilità.","Tool Proficiency":"Seleziona le competenze negli strumenti.","Fighting Style":"Scegli il tuo stile di combattimento.","Divine Domain":"Seleziona il tuo dominio divino.",Metamagic:"Scegli le opzioni di Metamagia."};let x=p();const B=document.getElementById("prevTrait"),I=document.getElementById("nextTrait"),A=document.getElementById("closeModal");function $(){x=p();const e=v();if(Object.entries({Languages:["languageSelection","Lingue Extra"],"Skill Proficiency":["skillSelectionContainer","Skill Proficiency"],"Tool Proficiency":["toolSelectionContainer","Tool Proficiency"]}).forEach(([e,[t,n]])=>{if(void 0!==x[e])!function(e,t,n){const o=document.getElementById(e);if(!o)return;const a=(x[n]||[]).filter(e=>e);a.length>0?(o.innerHTML=`<p><strong>${t}:</strong> ${a.join(", ")}</p>`,o.classList.remove("hidden")):(o.innerHTML="",o.classList.add("hidden"))}(t,n,e);else{const e=document.getElementById(t);e&&e.classList.add("hidden")}}),!e||0===e.length)return;const t=document.getElementById("extraSelectionTitle"),n=document.getElementById("extraSelectionDescription"),o=document.getElementById("extraSelectionContainer");if(!t||!n||!o)return;const a=e[k()];t.innerText=a.name;const i=a.description||L[a.name]||"";if(n.innerText=i,o.innerHTML="",a.selection){const e=b[a.name]||a.name,t=H({Languages:"languages","Skill Proficiency":"skills","Tool Proficiency":"tools",Cantrips:"cantrips"}[e]||""),n=(x[e]||[]).filter(e=>e).map(e=>e.toLowerCase()),i=new Set(n);t.forEach(e=>i.add(e));let l="";for(let t=0;t<a.count;t++)l+=`<select class="extra-selection" data-category="${e}" data-index="${t}"><option value="">Seleziona...</option>`,a.selection.forEach(e=>{const t=e.toLowerCase(),o=i.has(t)&&!n.includes(t);l+=`<option value="${e}" ${o?"disabled":""}>${e}</option>`}),l+="</select><br>";o.innerHTML=l,document.querySelectorAll(".extra-selection").forEach(e=>{e.addEventListener("change",e=>{const t=e.target.getAttribute("data-category"),n=b[t]||t,o=e.target.getAttribute("data-index");x[n]||(x[n]=[]),x[n][o]=e.target.value,m(),$()})})}if(B&&I&&A){const t=k();B.disabled=0===t,I.disabled=t===e.length-1;const n=e.every(e=>x[e.name]&&x[e.name].filter(e=>e).length===e.count);t===e.length-1&&n?A.style.display="inline-block":A.style.display="none"}}function _(){const e=v();e&&0!==e.length&&$()}function T(e){e&&e.querySelectorAll("details").forEach(e=>{const t=e.querySelector("summary"),n=Array.from(e.childNodes).filter(e=>e!==t),o=document.createElement("div"),a=["accordion-item","feature-block",...e.classList];o.className=a.join(" "),e.id&&(o.id=e.id);const i=document.createElement("button");i.type="button",i.className="accordion-header",i.innerHTML=t?t.innerHTML:"",o.appendChild(i);const l=document.createElement("div");l.className="accordion-content",n.forEach(e=>l.appendChild(e)),o.appendChild(l),e.replaceWith(o)})}function M(e){e&&e.querySelectorAll(".accordion-header").forEach((e,t)=>{const n=e.nextElementSibling;if(e.setAttribute("role","button"),e.hasAttribute("tabindex")||e.setAttribute("tabindex","0"),e.setAttribute("aria-expanded","false"),n){const o=e.id||`accordion-header-${t}`;e.id=o,n.setAttribute("role","region"),n.setAttribute("aria-labelledby",o)}const o=()=>{const t="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",String(!t)),e.classList.toggle("active",!t),n&&n.classList.toggle("show",!t),e.focus()};e.addEventListener("click",o),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),o())})})}async function D(){console.log("🛠 Esecuzione displayRaceTraits()...");const e=p(),t=document.getElementById("raceSelect").value,r=document.getElementById("raceTraits"),u=document.getElementById("racialBonusSelection");if(!t)return console.warn("⚠️ displayRaceTraits(): Nessuna razza selezionata."),r.textContent="",r.appendChild(a("Seleziona una razza per vedere i tratti.")),u.style.display="none",void K();console.log(`📜 Caricamento tratti per ${t}...`);try{const n=await fetch(t);if(!n.ok)throw new Error("Network response was not ok");const u=await n.json();console.log("📜 Dati razza caricati:",u);const m=function(e){let t="Unknown";t=Array.isArray(e.size)?"M"===e.size[0]?"Medium":"S"===e.size[0]?"Small":e.size[0]:e.size||"Unknown";let n={};if(e.speed)if("object"==typeof e.speed)for(let t in e.speed)n[t]="boolean"==typeof e.speed[t]?"fly"===t?"equal to your walking speed":"unknown":e.speed[t];else n=e.speed;let o={};e.senses&&"object"==typeof e.senses?o=e.senses:e.darkvision&&(o.darkvision=e.darkvision);let a={options:[]};e.ability&&Array.isArray(e.ability)&&e.ability.forEach(e=>{if(e.choose&&e.choose.weighted){const t=e.choose.weighted.weights;2===t.length&&t.includes(2)?a.options.push({type:"fixed",values:{any:2,any_other:1}}):3===t.length&&a.options.push({type:"three",values:{any:1,any_other:1,any_other_2:1}})}});let i=null,l=[];const s=e.entries||[];s.forEach(e=>{if("inset"===e.type&&e.name&&e.name.toLowerCase().includes("variant feature")){i=(e.entries||[]).map(e=>({name:e.name,description:d(e.entries)}));const t=i.map(e=>`<strong>${e.name}:</strong> ${e.description}`).join(" ");l.push({name:e.name,description:t,level_requirement:1})}else e.name&&e.entries&&l.push({name:e.name,description:d(e.entries),level_requirement:e.level||1})});let r={fixed:[],choice:0,options:[]};if(e.languageProficiencies&&e.languageProficiencies.length>0){const t=e.languageProficiencies[0];for(let e in t)!0===t[e]?r.fixed.push(e.charAt(0).toUpperCase()+e.slice(1)):"number"==typeof t[e]&&(r.choice=t[e]);r.choice>0&&0===r.options.length&&r.options.push("Any other language you and your DM agree is appropriate")}let u=null;if(e.skillProficiencies&&e.skillProficiencies.length>0){const t=e.skillProficiencies[0];t.choose&&t.choose.from?u={number:t.choose.count?t.choose.count:1,options:t.choose.from}:"number"==typeof t.any&&(u={number:t.any,options:c})}let p=null;e.toolProficiencies&&Array.isArray(e.toolProficiencies)&&e.toolProficiencies.forEach(e=>{e.choose&&e.choose.from&&(p={number:1,options:e.choose.from})});let m=null;if(e.additionalSpells&&e.additionalSpells.length>0){const t=e.additionalSpells[0];if(m={},t.ability){let e=[];e=Array.isArray(t.ability)?t.ability:"object"==typeof t.ability&&t.ability.choose?Array.isArray(t.ability.choose)?t.ability.choose:[t.ability.choose]:[t.ability],m.ability_choices=e.map(e=>e.toString().toUpperCase())}if(t.known){const e=[];Object.values(t.known).forEach(t=>{(t._||[]).forEach(t=>{"string"==typeof t?e.push(t):t.choose&&(m.spell_choices={type:"filter",filter:t.choose})})}),!m.spell_choices&&e.length>1?m.spell_choices={type:"fixed_list",options:e}:1===e.length&&(m.fixed_spell=e[0])}}return{name:e.name,source:e.source+(e.page?`, page ${e.page}`:""),size:t,speed:n,senses:o,ability_bonus:a,traits:l,rawEntries:s,spellcasting:m,languages:r,skill_choices:u,tool_choices:p,variant_feature_choices:i}}(u);window.currentRaceData=m,r.textContent="",r.appendChild(o(`Tratti di ${m.name}`,3));let g="Velocità: Non disponibile";if(m.speed)if("object"==typeof m.speed){g=`Velocità: ${Object.entries(m.speed).map(([e,t])=>`${e}: ${t} ft`).join(", ")}`}else g=`Velocità: ${m.speed} ft`;r.appendChild(a(g)),m.senses&&m.senses.darkvision&&r.appendChild(a(`Visione: ${m.senses.darkvision} ft`));let f=null;m.traits&&m.traits.length>0&&(r.appendChild(o("Tratti:",4)),m.traits.forEach(t=>{const n=`trait-${t.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}`,o=t.name,a=document.createElement("details");a.className="race-trait feature-block",a.id=n;const i=document.createElement("summary");i.textContent=t.name,a.appendChild(i);const l=document.createElement("div");l.className="feature-desc",l.textContent=t.description||"",a.appendChild(l);const s=t.choices||t.variant_feature_choices;s&&s.forEach((t,n)=>{const i=t.options||t.selection||[],l=e[o]?.[n]||"",s=document.createElement("label");s.textContent=(t.name||"Scegli")+": ";const c=document.createElement("select");c.dataset.feature=o,c.dataset.index=n;const r=document.createElement("option");r.value="",r.textContent="Seleziona...",c.appendChild(r),i.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l===e&&(t.selected=!0),c.appendChild(t)}),s.appendChild(c),a.appendChild(s)}),t.name.toLowerCase().includes("cantrip")&&(f=a),r.appendChild(a)}));const E=O(m,"race");S(E);const C={Languages:/language/i,"Skill Proficiency":/skill/i,"Tool Proficiency":/tool/i};E.forEach((t,n)=>{const o=b[t.name]||t.name;let a=null;const i=C[t.name];if(i&&(a=Array.from(r.querySelectorAll("details")).find(e=>i.test(e.querySelector("summary")?.textContent||""))),!a){a=document.createElement("details"),a.className="race-trait feature-block",a.id=`race-extra-${n}`;const e=document.createElement("summary");e.textContent=t.name,a.appendChild(e),r.appendChild(a)}if(t.description&&!a.querySelector(".feature-desc")){const e=document.createElement("div");e.className="feature-desc",e.textContent=t.description,a.appendChild(e)}const l=t.selection||[],s=t.count||1;for(let n=0;n<s;n++){const i=e[o]?.[n]||"",c=document.createElement("label");c.textContent=`${t.name}${s>1?" "+(n+1):""}: `;const r=document.createElement("select");r.dataset.feature=o,r.dataset.index=n;const d=document.createElement("option");d.value="",d.textContent="Seleziona...",r.appendChild(d),l.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,i===e&&(t.selected=!0),r.appendChild(t)}),c.appendChild(r),a.appendChild(c)}});const v={Languages:"Linguaggi","Skill Proficiency":"Abilità","Tool Proficiency":"Strumenti"},k=(e,t,n,o,a)=>{if(!t||0===t.length)return;let i=Array.from(r.querySelectorAll("details")).find(e=>a.test(e.querySelector("summary")?.textContent||""));if(!i){i=document.createElement("details"),i.className="race-trait feature-block";const e=document.createElement("summary");e.textContent=o,i.appendChild(e),r.appendChild(i)}const l=document.createElement("div");i.appendChild(l);const s=()=>{l.innerHTML="",h(e,t,n,l,{featureKey:o,label:v[o],selectedData:p(),getTakenOptions:{excludeRace:!0},changeHandler:()=>setTimeout(s,0)})};s()};if(k("languages",m.languages?.fixed,s,"Languages",/language/i),k("skills",m.skill_choices?.fixed,c,"Skill Proficiency",/skill/i),k("tools",m.tool_choices?.fixed,l,"Tool Proficiency",/tool/i),m.variant_feature_choices){const e=document.createElement("details");e.className="race-trait feature-block needs-selection incomplete",e.id="variantFeatureTrait";const t=document.createElement("summary");t.textContent="Variant Feature",e.appendChild(t);const n=document.createElement("div");n.id="variantFeatureSelectionContainer",e.appendChild(n);const o=document.createElement("div");o.id="variantExtraContainer",e.appendChild(o),r.appendChild(e)}const w=document.createElement("details");w.className="race-trait feature-block hidden",w.id="ancestryTrait";const L=document.createElement("summary");L.textContent="Ancestry",w.appendChild(L);const x=document.createElement("div");x.id="ancestrySelectionContainer",w.appendChild(x),r.appendChild(w);const B=function(e){let t="";return e&&Array.isArray(e)?(e.forEach(e=>{e.entries&&Array.isArray(e.entries)&&e.entries.forEach(n=>{if("object"==typeof n&&"table"===n.type){if(t+='<div class="table-container" style="margin-top:1em; margin-bottom:1em;">',n.caption&&(t+=`<p><strong>${n.caption}</strong></p>`),t+='<table border="1" style="width:100%; border-collapse: collapse;">',n.colLabels&&Array.isArray(n.colLabels)&&(t+="<thead><tr>",n.colLabels.forEach(e=>{t+=`<th style="padding: 0.5em; text-align: center;">${e}</th>`}),t+="</tr></thead>"),n.rows&&Array.isArray(n.rows)&&(t+="<tbody>",n.rows.forEach(e=>{t+="<tr>",e.forEach(e=>{t+=`<td style="padding: 0.5em; text-align: center;">${e}</td>`}),t+="</tr>"}),t+="</tbody>"),t+="</table>",e.name&&e.name.toLowerCase().includes("ancestry")){let e='<option value="">Seleziona...</option>';n.rows.forEach(t=>{const n=JSON.stringify(t),o=`${t[0]} (${t[1]})`;e+=`<option value='${n}'>${o}</option>`}),t+=`<p><strong>Seleziona Ancestry:</strong>\n                      <select id="ancestrySelect">${e}</select>\n                     </p>`}t+="</div>"}})}),t):t}(m.rawEntries);if(B){const e=document.createElement("div");e.appendChild(document.createRange().createContextualFragment(B)),r.appendChild(e)}await function(e,t){return new Promise(n=>{const o="string"==typeof t?document.getElementById(t):t;if(!o||!e.spellcasting)return void n();if(console.log(`🔍 JSON Spellcasting per ${e.name}:`,e.spellcasting),e.spellcasting.fixed_spell){const t=document.createElement("p");t.innerHTML=`<strong>✨ Assigned spell:</strong> ${e.spellcasting.fixed_spell}`,o.appendChild(t)}const a=()=>{if(e.spellcasting.ability_choices&&Array.isArray(e.spellcasting.ability_choices)&&(console.log(`🧙‍♂️ Checking casting ability for ${e.name}:`,e.spellcasting.ability_choices),e.spellcasting.ability_choices.length>1)){const t=e.spellcasting.ability_choices.map(e=>`<option value="${e.toUpperCase()}">${e.toUpperCase()}</option>`).join(""),n=document.createElement("div");n.innerHTML=`\n            <p><strong>🧠 Select the casting ability:</strong></p>\n            <select id="castingAbility">\n              <option value="">Select...</option>${t}\n            </select>`,o.appendChild(n)}n()};if(e.spellcasting.spell_choices)if("fixed_list"===e.spellcasting.spell_choices.type){const t=e.spellcasting.spell_choices.options.map(e=>`<option value="${e}">${e}</option>`).join(""),n=document.createElement("div");n.innerHTML=`\n          <p><strong>🔮 Choose a spell:</strong></p>\n          <select id="spellSelection">\n            <option value="">Select...</option>${t}\n          </select>`,o.appendChild(n),a()}else if("filter"===e.spellcasting.spell_choices.type){const t=e.spellcasting.spell_choices.filter.split("|"),n=t.find(e=>e.startsWith("level="))?.split("=")[1],l=t.find(e=>e.startsWith("class="))?.split("=")[1];if(n&&l)i(e=>{const t=H("cantrips"),i=e.filter(e=>parseInt(e.level)===parseInt(n)&&e.spell_list.includes(l)&&!t.has(e.name.toLowerCase())).map(e=>`<option value="${e.name}">${e.name}</option>`).join(""),s=document.createElement("div");s.innerHTML=i?`\n                <p><strong>🔮 Choose a ${l} Cantrip:</strong></p>\n                <select id="spellSelection">\n                  <option value="">Select...</option>${i}\n                </select>`:`<p><strong>⚠️ No Cantrip available for ${l}.</strong></p>`,o.appendChild(s),a()});else{const e=document.createElement("p");e.innerHTML="<strong>⚠️ Error: Spell filter is not valid for this race.</strong>",o.appendChild(e),a()}}else a();else a()})}(m,f),function(e){if(!e.variant_feature_choices)return;const t=document.getElementById("variantFeatureSelectionContainer");if(!t)return;let n='<p><strong>Scegli una Variant Feature:</strong></p><select id="variantFeatureChoice">\n                <option value="">Seleziona...</option>';e.variant_feature_choices.forEach(e=>{n+=`<option value="${e.name}">${e.name}</option>`}),n+="</select>",t.innerHTML=n,document.getElementById("variantFeatureChoice").addEventListener("change",y)}(m),function(e,t){if(e.variant_feature_choices&&e.variant_feature_choices.length>0){const n=e.variant_feature_choices.filter(e=>e.name.toLowerCase().includes("ancestry"));if(n.length>0){let e='<h4>Seleziona Ancestry</h4>\n                  <select id="ancestrySelection">\n                    <option value="">Seleziona...</option>';n.forEach(t=>{e+=`<option value="${t.name}">${t.name}</option>`}),e+="</select>";const o=document.getElementById(t);o&&(o.innerHTML=e)}}else{const e=document.getElementById(t);e&&(e.innerHTML="")}}(m,"ancestrySelectionContainer"),T(r),r.classList.add("accordion"),r.style.display="block",R(r,J),M(r);const I=document.getElementById("ancestryTrait");if(I){const e=document.getElementById("ancestrySelectionContainer");e&&""!==e.innerHTML.trim()?(I.classList.remove("hidden"),I.classList.add("needs-selection")):I.remove()}const A=document.getElementById("variantFeatureChoice");A&&(A.addEventListener("change",()=>{p()["Variant Feature"]=[A.value],y(),z("variantFeatureTrait")}),z("variantFeatureTrait"));const $=document.getElementById("ancestrySelection");$&&($.addEventListener("change",()=>{p().Ancestry=[$.value],z("ancestryTrait")}),z("ancestryTrait")),K()}catch(e){n(`Errore caricando i tratti della razza: ${e}`)}}B&&I&&(B.addEventListener("click",()=>{const e=k();e>0&&(w(e-1),_())}),I.addEventListener("click",()=>{const e=k();e<v().length-1&&(w(e+1),_())})),A&&A.addEventListener("click",()=>{const e=document.getElementById("raceExtrasModal");e&&e.classList.add("hidden"),sessionStorage.removeItem("popupOpened"),m()}),$();const j=document.getElementById("raceSelect");async function q(){const e=document.getElementById("classFeatures"),t=window.currentClassData;if(!e)return;if(!t)return e.textContent="",void e.appendChild(a("Seleziona una classe per vedere i tratti."));const n=p(),i=parseInt(document.getElementById("levelSelect")?.value)||1,l=document.getElementById("subclassSelect")?.value||"";e.textContent="",e.appendChild(o(t.name,3)),t.description&&e.appendChild(a(t.description));const r=[];if(t.weapon_proficiencies&&r.push(`Weapon Training: ${t.weapon_proficiencies.join(", ")}`),t.armor_proficiencies&&r.push(`Armor Training: ${t.armor_proficiencies.join(", ")}`),t.skill_proficiencies&&t.skill_proficiencies.choose&&r.push(`Skill Proficiencies: Choose ${t.skill_proficiencies.choose} from ${t.skill_proficiencies.options.join(", ")}`),t.skill_proficiencies&&Array.isArray(t.skill_proficiencies.fixed)&&t.skill_proficiencies.fixed.length&&r.push(`Skill Proficiencies: ${t.skill_proficiencies.fixed.join(", ")}`),t.language_proficiencies&&Array.isArray(t.language_proficiencies.fixed)&&t.language_proficiencies.fixed.length&&r.push(`Languages: ${t.language_proficiencies.fixed.join(", ")}`),t.multiclassing&&t.multiclassing.prerequisites){const e=Object.entries(t.multiclassing.prerequisites).map(([e,t])=>`${e} ${t}`).join(", ");r.push(`Multiclassing Prerequisite: ${e}`)}if(r.length){const n=document.createElement("details");n.className="feature-block";const o=document.createElement("summary");o.textContent="Proficiencies",n.appendChild(o),r.forEach(e=>n.appendChild(a(e)));const i=(e,t,o,a,i)=>{const l=document.createElement("div");n.appendChild(l);const s=()=>{l.innerHTML="",h(e,t,o,l,{featureKey:a,label:i,selectedData:p(),getTakenOptions:{excludeClass:!0},changeHandler:()=>setTimeout(s,0)})};s()};i("languages",t.language_proficiencies?.fixed,s,"Languages","Linguaggi"),i("skills",t.skill_proficiencies?.fixed,c,"Skill Proficiency","Abilità"),e.appendChild(n)}if(t.subclasses&&t.subclasses.length>0){const n=document.createElement("details");n.className="feature-block",n.id="subclassTrait";const o=document.createElement("summary");o.textContent="Sottoclasse",n.appendChild(o);const a=document.createElement("select");a.id="subclassSelect",a.className="form-control";const i=document.createElement("option");i.value="",i.textContent="Seleziona una sottoclasse",a.appendChild(i),t.subclasses.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,l===e.name&&(t.selected=!0),a.appendChild(t)}),n.appendChild(a),e.appendChild(n)}let d=null;if(l)try{const t=function(e){let t=e.toLowerCase();t.startsWith("college of ")?t="college_of_"+t.slice(11):t.startsWith("circle of the ")?t="circle_of_the_"+t.slice(14):t.startsWith("circle of ")?t="circle_of_"+t.slice(10):(t=t.replace(/^(path|oath|way|school) of the /,"").replace(/^(path|oath|way|school) of /,"").replace(/^the /,""),t.endsWith(" domain")&&(t=t.slice(0,-7)));let n=t.replace(/ /g,"_")+".json";return"wild_magic.json"===n&&"Barbarian"===window.currentClassData?.name&&(n="barbarian_wild_magic.json"),n}(l),n=await fetch(`data/subclasses/${t}`);if(!n.ok)throw new Error("Network response was not ok");d=await n.json(),d.description&&e.appendChild(a(d.description))}catch(t){e.appendChild(a("Dettagli della sottoclasse non disponibili."))}else e.appendChild(a("Seleziona una sottoclasse per vedere i tratti."));const u={};t.features_by_level&&Object.entries(t.features_by_level).forEach(([e,t])=>{u[e]=[...t]}),d?.features_by_level&&Object.entries(d.features_by_level).forEach(([e,t])=>{u[e]||(u[e]=[]),u[e].push(...t)});Object.keys(u).sort((e,t)=>e-t).forEach(t=>{parseInt(t)<=i&&(e.appendChild(o(`Livello ${t}`,4)),u[t].forEach((o,a)=>{if("string"==typeof o){const t=document.createElement("details");t.className="feature-block";const n=document.createElement("summary");n.textContent=o,t.appendChild(n),e.appendChild(t)}else{const i=document.createElement("details");i.className="feature-block",i.id=`class-feature-${t}-${a}`;const l=document.createElement("summary");if(l.textContent=o.name,i.appendChild(l),o.description){const e=document.createElement("div");e.className="feature-desc",e.textContent=o.description,i.appendChild(e)}const s=o.choices||o.variant_feature_choices;s&&s.forEach((e,t)=>{const a=e.options||e.selection||[],l=n[o.name]?.[t]||"",s=document.createElement("label");s.textContent=(e.name||"Scegli")+": ";const c=document.createElement("select");c.dataset.feature=o.name,c.dataset.index=t;const r=document.createElement("option");r.value="",r.textContent="Seleziona...",c.appendChild(r),a.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l===e&&(t.selected=!0),c.appendChild(t)}),s.appendChild(c),i.appendChild(s)}),e.appendChild(i)}}))});const m=[...t.choices||[],...d?.choices||[]];t.skill_proficiencies&&!m.some(e=>"Skill Proficiency"===e.name)&&m.push({level:1,name:"Skill Proficiency",description:`Choose ${t.skill_proficiencies.choose} from the class skill list`,count:t.skill_proficiencies.choose,selection:t.skill_proficiencies.options});const g=O({choices:m},"class",i);S(g);const f={Languages:/Proficiencies/i,"Skill Proficiency":/Proficiencies/i};g.forEach(t=>{const o=b[t.name]||t.name,a=Array.from(e.querySelectorAll("details"));let i=a.find(e=>{const n=e.querySelector("summary")?.textContent||"";return n===t.name||n===o});if(!i){const e=f[t.name]||f[o];e&&(i=a.find(t=>e.test(t.querySelector("summary")?.textContent||"")))}if(!i){i=document.createElement("details"),i.className="feature-block";const n=document.createElement("summary");n.textContent=t.name,i.appendChild(n),e.appendChild(i)}if(t.description&&!i.querySelector(".feature-desc")){const e=document.createElement("div");e.className="feature-desc",e.textContent=t.description,i.appendChild(e)}const l=t.options||t.selection||[],s=[];for(let e=0;e<(t.count||1);e++){const a=t.selected?.[e]||n[o]?.[e]||"",c=document.createElement("label");c.textContent=`${t.name}${t.count>1?" "+(e+1):""}: `;const r=document.createElement("select");r.dataset.feature=o,r.dataset.index=e,r.dataset.options=JSON.stringify(l);const d=document.createElement("option");d.value="",d.textContent="Seleziona...",r.appendChild(d),l.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),a&&(r.value=a),c.appendChild(r),i.appendChild(c),s.push(r)}const c=()=>{const e=new Set(s.map(e=>e.value).filter(Boolean));s.forEach(t=>{const n=JSON.parse(t.dataset.options),o=t.value;t.innerHTML='<option value="">Seleziona...</option>'+n.map(t=>`<option value="${t}" ${e.has(t)&&t!==o?"disabled":""}>${t}</option>`).join(""),t.value=o})};s.forEach(e=>e.addEventListener("change",c)),c()}),T(e),e.classList.add("accordion"),R(e,J),M(e);const y=document.getElementById("subclassSelect");y&&y.addEventListener("change",q)}j&&j.addEventListener("change",()=>{console.log("🔄 Razza cambiata, reset delle selezioni extra..."),u={},m(),N=p(),document.getElementById("languageSelection").innerHTML="",document.getElementById("skillSelectionContainer").innerHTML="",document.getElementById("toolSelectionContainer").innerHTML="",D(),document.getElementById("confirmRaceSelection").style.display="inline-block"});let N=p();function z(e){const t=document.getElementById(e);if(!t)return;const n=[...t.querySelectorAll("select")].some(e=>!e.value);t.classList.toggle("incomplete",n)}function P(e){return e?e.replace(/#.*$/,"").toLowerCase():""}function H(e,t={}){const{excludeRace:n=!1,excludeClass:o=!1,excludeBackground:a=!1}=t,i=new Set;if((N[{skills:"Skill Proficiency",tools:"Tool Proficiency",languages:"Languages",cantrips:"Cantrips"}[e]]||[]).filter(e=>e).forEach(e=>i.add(e.toLowerCase())),!a&&window.backgroundData){const t={skills:"skills",tools:"tools",languages:"languages",cantrips:"cantrips"},n=window.backgroundData[t[e]];Array.isArray(n)?n.forEach(e=>i.add(e.toLowerCase())):"string"==typeof n&&i.add(n.toLowerCase()),"cantrips"===e&&window.backgroundData.spellcasting&&window.backgroundData.spellcasting.fixed_spell&&i.add(P(window.backgroundData.spellcasting.fixed_spell))}if(!o&&window.currentClassData)if("tools"===e){const e=window.currentClassData.tool_proficiencies;Array.isArray(e)?e.forEach(e=>{const t=e.toLowerCase();t.includes("of your choice")||t.includes(" or ")||i.add(t)}):e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>i.add(e.toLowerCase()))}else if("skills"===e){const e=window.currentClassData.skill_proficiencies;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>i.add(e.toLowerCase()))}else if("languages"===e){const e=window.currentClassData.language_proficiencies;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>i.add(e.toLowerCase()))}else if("cantrips"===e){const e=window.currentClassData.spellcasting;e&&(Array.isArray(e.fixed_cantrips)&&e.fixed_cantrips.forEach(e=>i.add(P(e))),e.fixed_spell&&i.add(P(e.fixed_spell)))}if(!n&&window.currentRaceData)if("languages"===e){const e=window.currentRaceData.languages;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>i.add(e.toLowerCase()))}else if("skills"===e){const e=window.currentRaceData.skill_choices;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>i.add(e.toLowerCase()))}else if("tools"===e){const e=window.currentRaceData.tool_choices;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>i.add(e.toLowerCase()))}else if("cantrips"===e){const e=window.currentRaceData.spellcasting;e&&(Array.isArray(e.fixed_cantrips)&&e.fixed_cantrips.forEach(e=>i.add(P(e))),e.fixed_spell&&i.add(P(e.fixed_spell)))}return i}function F(e,t,n={}){const o=H(e,n);if(!t)return o;const a=t.map(e=>e.toLowerCase()),i=t.filter((e,t)=>o.has(a[t]));return{taken:new Set([...o,...a]),conflicts:i}}function O(e,t,n=1){const o=[],a=F("languages"),i=F("skills"),l=F("tools");if("race"===t){if(e.languages&&(e.languages.fixed.length>0||e.languages.choice>0)){const t=new Set(e.languages.fixed.map(e=>e.toLowerCase())),n=s.filter(e=>!t.has(e.toLowerCase())),{options:i,note:l}=r("languages",n,a),c=e.languages.fixed.length?`<strong>Lingue Concesse:</strong> ${e.languages.fixed.join(", ")}`:"";o.push({name:"Languages",description:c+l,selection:i,count:e.languages.choice})}if(e.skill_choices){const{options:t,note:n}=r("skills",e.skill_choices.options,i);t.length>0&&o.push({name:"Skill Proficiency",description:"Choose skill proficiencies."+n,selection:t,count:e.skill_choices.number})}if(e.tool_choices){const{options:t,note:n}=r("tools",e.tool_choices.options,l);t.length>0&&o.push({name:"Tool Proficiency",description:"Choose a tool proficiency."+n,selection:t,count:1})}}else if("class"===t){(e.choices||[]).forEach(e=>{if(!e.level||parseInt(e.level)<=n){const t=b[e.name]||e.name;if("Tool Proficiency"===t)return;const n=(N[t]||[]).filter(e=>e);let l=e.selection||e.options||[],s="";const c={Languages:{type:"languages",taken:a},"Skill Proficiency":{type:"skills",taken:i}}[t];if(c){const e=r(c.type,l,c.taken,n);l=e.options,s=e.note}const d=s?(e.description||"")+s:e.description;o.push({...e,selection:l,description:d,selected:n})}})}return o}function R(e,t){if(!e)return;e.querySelectorAll(".feature-block").forEach(e=>{const n=e.querySelectorAll("select");if(0===n.length)return;e.classList.add("user-choice");const o=()=>{const t=Array.from(n).some(e=>!e.value);e.classList.toggle("needs-selection",t)};o(),n.forEach(e=>{e.addEventListener("change",()=>{t&&t(e),o()})})})}function J(e){const t=e.dataset.feature,n=e.dataset.index||0;t&&(N[t]||(N[t]=[]),N[t][n]=e.value||void 0,m())}function W(){const e=document.getElementById("finalRecap");if(!e)return;N=p();const t=document.getElementById("userName")?.value||"",n=document.getElementById("characterName")?.value||"",o=document.getElementById("classSelect").selectedOptions[0]?.text||"",a=document.getElementById("subclassSelect").selectedOptions[0]?.text||"",i=document.getElementById("raceSelect").selectedOptions[0]?.text||"",l=document.getElementById("levelSelect")?.value||"",s=document.getElementById("origin")?.value||"",c=document.getElementById("age")?.value||"",r=window.backgroundData&&window.backgroundData.languages||[],d=window.backgroundData&&window.backgroundData.tools||[],u=N.Languages||[],m=N["Tool Proficiency"]||[],g=[...new Set([...r,...u])],h=[...new Set([...d,...m])],f=N.equipment||{},y=[...f.standard||[],...f.class||[],...f.upgrades||[]];let E="";E+=`<p><strong>Nome Utente:</strong> ${t}</p>`,E+=`<p><strong>Nome PG:</strong> ${n}</p>`,E+=`<p><strong>Classe:</strong> ${o}${a?` (${a})`:""}</p>`,E+=`<p><strong>Razza:</strong> ${i}</p>`,E+=`<p><strong>Livello:</strong> ${l}</p>`,E+=`<p><strong>Provenienza:</strong> ${s}</p>`,E+=`<p><strong>Età:</strong> ${c}</p>`,E+=`<p><strong>Lingue:</strong> ${g.join(", ")}</p>`,E+=`<p><strong>Strumenti:</strong> ${h.join(", ")}</p>`,E+=`<p><strong>Equip:</strong> ${y.join(", ")}</p>`,e.innerHTML=E}function V(){let e=null;const t=document.getElementById("ancestrySelect");if(t&&t.value)try{e=JSON.parse(t.value)}catch(e){console.error("Errore nel parsing della Chromatic Ancestry scelta",e)}const n=document.getElementById("toolChoice0")?document.getElementById("toolChoice0").value:null,o=document.getElementById("variantFeatureChoice")?document.getElementById("variantFeatureChoice").value:null,a={},i=document.querySelectorAll(".variantSkillChoice");i.length>0&&(a.skills=[],i.forEach(e=>{e.value&&a.skills.push(e.value)}));const l=document.getElementById("variantSpellChoice");l&&l.value&&(a.spell=l.value);const s=window.backgroundData&&window.backgroundData.languages||[],c=[...new Set([...N.Languages||[],...s])],r={user_name:document.getElementById("userName")?.value||"",name:document.getElementById("characterName").value||"Senza Nome",origin:document.getElementById("origin")?.value||"",age:document.getElementById("age")?.value||"",level:document.getElementById("levelSelect").value||"1",race:document.getElementById("raceSelect").selectedOptions[0]?.text||"Nessuna",class:document.getElementById("classSelect").selectedOptions[0]?.text||"Nessuna",subclass:document.getElementById("subclassSelect").selectedOptions[0]?.text||"Nessuna",background:window.backgroundData?window.backgroundData.name:"Nessuno",stats:{strength:document.getElementById("strFinalScore").textContent,dexterity:document.getElementById("dexFinalScore").textContent,constitution:document.getElementById("conFinalScore").textContent,intelligence:document.getElementById("intFinalScore").textContent,wisdom:document.getElementById("wisFinalScore").textContent,charisma:document.getElementById("chaFinalScore").textContent},racial_bonus:{strength:document.getElementById("strRaceModifier").textContent,dexterity:document.getElementById("dexRaceModifier").textContent,constitution:document.getElementById("conRaceModifier").textContent,intelligence:document.getElementById("intRaceModifier").textContent,wisdom:document.getElementById("wisRaceModifier").textContent,charisma:document.getElementById("chaRaceModifier").textContent},background_proficiencies:window.backgroundData?{skills:window.backgroundData.skills||[],tools:window.backgroundData.tools||[],languages:window.backgroundData.languages||[]}:{skills:[],tools:[],languages:[]},background_feat:window.backgroundData&&window.backgroundData.feat||"",equipment:N.equipment||{standard:[],class:[],upgrades:[]},languages:{selected:c},selections:N,chromatic_ancestry:e,tool_proficiency:n,variant_feature:o,variant_extra:a};console.log("✅ JSON finale generato:"),console.log(JSON.stringify(r,null,2));!function(e,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o)}(r.name.replace(/[^a-z0-9]/gi,"_").toLowerCase()+"_character.json",r),alert("JSON generato e scaricato!")}$();var U=27;function G(){const e=parseInt(document.getElementById("levelSelect")?.value)||1;["str","dex","con","int","wis","cha"].forEach(t=>{const n=parseInt(document.getElementById(`${t}Points`).textContent),o=parseInt(document.getElementById(`${t}RaceModifier`).textContent),a=document.getElementById(`${t}BackgroundTalent`),i=n+o+(a&&parseInt(a.value)||0),l=document.getElementById(`${t}FinalScore`);1===e&&i>17?(l.textContent="Errore",l.style.color="red"):(l.textContent=i,l.style.color="")}),console.log("🔄 Punteggi Finali aggiornati!")}function K(){document.getElementById("racialBonus1").value="",document.getElementById("racialBonus2").value="",document.getElementById("racialBonus3").value="";["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent="0")}),window.racialBonusesConfirmed=!1,G()}window.applyRacialBonuses=function(){console.log("⚡ applyRacialBonuses() chiamata!");const e=document.getElementById("racialBonus1").value,t=document.getElementById("racialBonus2").value,o=document.getElementById("racialBonus3").value;if(!e||!t||!o)return void n("Devi selezionare tutti e tre i bonus razziali!");const a={};[e,t,o].forEach(e=>{a[e]=(a[e]||0)+1});const i=Object.values(a);if(!(i.includes(2)&&i.includes(1)&&2===Object.keys(a).length||i.every(e=>1===e)&&3===Object.keys(a).length))return void n("Puoi assegnare +2 a una caratteristica e +1 a un'altra, oppure +1 a tre diverse!");["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent=a[e]?a[e]:"0")}),console.log("✅ Bonus razziali applicati:",a),window.racialBonusesConfirmed=!0,G()},window.adjustPoints=function(e,t){const n=document.getElementById(e+"Points");let o=parseInt(n.textContent);"add"===t&&U>0&&o<15?(U-=o>=13?2:1,o++):"subtract"===t&&o>8&&(U+=o>13?2:1,o--),n.textContent=o;const a=document.getElementById("pointsRemaining");a&&(a.textContent=U),G()};let Q={},Y=null;function X(){sessionStorage.setItem("backgroundData",JSON.stringify(window.backgroundData))}function Z(e,t){let n=t.querySelector(".skill-summary");e&&0!==e.length?(n||(n=document.createElement("p"),n.className="skill-summary",t.appendChild(n)),n.innerHTML=`<strong>Abilità:</strong> ${e.join(", ")}`):n&&n.remove()}function ee(e){T(e),e.classList.add("accordion"),M(e)}function te(){["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"BackgroundTalent");t&&(t.value=0)})}function ne(){te(),Y&&Y.fixedAbilities&&Y.fixedAbilities.forEach(e=>{const t=Object.keys(e)[0],n=e[t],o=document.getElementById(t+"BackgroundTalent");o&&(o.value=n)});document.querySelectorAll(".featAbilityChoice").forEach(e=>{if(e.value){const t=parseInt(e.dataset.amount||"1"),n=document.getElementById(e.value+"BackgroundTalent");n&&(n.value=t)}}),updateFinalScores()}function oe(e,t,n,o){const a=t.querySelector(`.duplicate-${e}-choices`);a&&a.remove(),window.backgroundData[e]=n.slice();const{taken:i,conflicts:l}=F(e,n,{excludeBackground:!0});if(X(),"skills"===e&&Z(window.backgroundData[e],t),0===l.length)return t.classList.remove("needs-selection","incomplete"),void R(t.parentElement);const s=n.filter(e=>!l.includes(e)),c=document.createElement("div");c.className=`duplicate-${e}-choices`;const{label:r,selectClass:d}={skills:{label:"Abilità",selectClass:"duplicateSkillChoice"},tools:{label:"Strumenti",selectClass:"duplicateToolChoice"},languages:{label:"Linguaggi",selectClass:"duplicateLanguageChoice"}}[e];t.appendChild(c),h(e,n,o,c,{label:r,selectClass:d,getTakenOptions:{excludeBackground:!0},changeHandler:n=>{const a=n.filter(Boolean);window.backgroundData[e]=s.concat(a),X(),"skills"===e&&Z(window.backgroundData[e],t),a.length!==l.length?t.classList.toggle("incomplete",a.length<l.length):oe(e,t,window.backgroundData[e],o)}}),t.classList.add("needs-selection","incomplete"),R(t.parentElement)}document.addEventListener("DOMContentLoaded",async()=>{if(!document.getElementById("step4"))return;const e=sessionStorage.getItem("backgroundData");window.backgroundData=e?JSON.parse(e):{name:"",skills:[],tools:[],languages:[],feat:""};const n=window.backgroundData;X(),t("data/backgrounds.json","backgroundSelect");try{const e=await fetch("data/feats.json");if(!e.ok)throw new Error("Failed to load feats");const t=await e.json();Q=t.feats||{}}catch(e){console.error("Errore caricando i talenti:",e)}document.getElementById("backgroundSelect").addEventListener("change",async e=>{const t=e.target.value;if(t)try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const o=await e.json();n.name=o.name,X();const a=document.getElementById("backgroundSkills");a.innerHTML="";const i=document.createElement("details");i.className="feature-block",i.innerHTML="<summary>Abilità</summary>",n.skills=Array.isArray(o.skills)?o.skills.slice():[];const r=o.skillChoices&&o.skillChoices.options?o.skillChoices.options:c;if(o.skillChoices){const e=o.skillChoices.choose||0,t=F("skills");let a=(o.skillChoices.options||[]).filter(e=>!t.has(e.toLowerCase())),l="";0===a.length&&(a=c.filter(e=>!t.has(e.toLowerCase())),l=" (tutte le abilità disponibili)");const s=document.createElement("p");s.innerHTML=`<strong>Scegli ${e} abilità${l}:</strong>`,i.appendChild(s),g(i,e,a,"backgroundSkillChoice",()=>{const e=Array.from(document.querySelectorAll(".backgroundSkillChoice")).map(e=>e.value).filter(Boolean);n.skills=(o.skills||[]).concat(e),oe("skills",i,n.skills,r),Z(n.skills,i)})}a.appendChild(i),oe("skills",i,n.skills,r),Z(n.skills,i),ee(a);const d=document.getElementById("backgroundTools");d.innerHTML="";const u=document.createElement("details");if(u.className="feature-block",u.innerHTML="<summary>Strumenti</summary>",n.tools=Array.isArray(o.tools)?o.tools.slice():[],Array.isArray(o.tools)&&o.tools.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Strumenti:</strong> ${o.tools.join(", ")}`,u.appendChild(e)}const p=()=>{const e=Array.from(document.querySelectorAll(".backgroundToolChoice")).map(e=>e.value).filter(Boolean),t=Array.isArray(o.tools)?o.tools.slice():[];n.tools=t.concat(e),oe("tools",u,n.tools,l)},m=F("tools");if(o.tools&&o.tools.choose){const e=o.tools.choose;let t=(o.tools.options||[]).filter(e=>!m.has(e.toLowerCase())),n="";0===t.length&&(t=l.filter(e=>!m.has(e.toLowerCase())),n=" (tutti gli strumenti disponibili)");const a=document.createElement("p");a.innerHTML=`<strong>Scegli ${e} strumento${n}:</strong>`,u.appendChild(a),g(u,e,t,"backgroundToolChoice",p)}if(o.toolChoices){const e=o.toolChoices.choose||0;let t=(o.toolChoices.options||[]).filter(e=>!m.has(e.toLowerCase())),n="";0===t.length&&(t=l.filter(e=>!m.has(e.toLowerCase())),n=" (tutti gli strumenti disponibili)");const a=document.createElement("p");a.innerHTML=`<strong>Scegli ${e} strumento${n}:</strong>`,u.appendChild(a),g(u,e,t,"backgroundToolChoice",p)}d.appendChild(u),oe("tools",u,n.tools,l),ee(d);const h=document.getElementById("backgroundLanguages");h.innerHTML="";const f=document.createElement("details");if(f.className="feature-block",f.innerHTML="<summary>Linguaggi</summary>",n.languages=Array.isArray(o.languages)?o.languages.slice():[],Array.isArray(o.languages)&&o.languages.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Linguaggi:</strong> ${o.languages.join(", ")}`,f.appendChild(e),h.appendChild(f),oe("languages",f,n.languages,s),ee(h)}else if(o.languages&&o.languages.choose){const e=o.languages.choose,t=t=>{const o=F("languages");let a=(t||[]).filter(e=>!o.has(e.toLowerCase())),i="";0===a.length&&(a=s.filter(e=>!o.has(e.toLowerCase())),i=" (tutte le lingue disponibili)");const l=document.createElement("p");l.innerHTML=`<strong>Scegli ${e} linguaggi${i}:</strong>`,f.appendChild(l),g(f,e,a,"backgroundLanguageChoice",()=>{const e=Array.from(document.querySelectorAll(".backgroundLanguageChoice")).map(e=>e.value).filter(Boolean);n.languages=e,oe("languages",f,n.languages,s)}),h.appendChild(f),oe("languages",f,n.languages,s),ee(h)};o.languages.any?t(s):t(o.languages.options||[])}else h.appendChild(f),oe("languages",f,n.languages,s),ee(h);const y=document.getElementById("backgroundFeat");y.innerHTML="",n.feat="",Y=null,X();const E=document.createElement("details");if(E.className="feature-block",E.innerHTML="<summary>Talento</summary>",Array.isArray(o.featOptions)&&o.featOptions.length>0){const e=document.createElement("label");e.htmlFor="backgroundFeatSelect",e.textContent="Feat:";const t=document.createElement("select");t.id="backgroundFeatSelect",t.innerHTML='<option value="">Seleziona un talento</option>'+o.featOptions.map(e=>`<option value="${e}">${e}</option>`).join("");const a=document.createElement("div");a.id="featAbilityChoices",t.addEventListener("change",async()=>{if(Y=null,a.innerHTML="",n.feat=t.value||"",X(),te(),t.value&&Q[t.value])try{const e=await fetch(Q[t.value]);if(!e.ok)throw new Error("Failed to load feat");const n=await e.json(),o=[];n.ability&&n.ability.forEach(e=>{if(e.choose){const t=document.createElement("select");t.className="featAbilityChoice",t.dataset.amount=e.choose.amount||1,t.innerHTML='<option value="">Seleziona caratteristica</option>'+e.choose.from.map(e=>`<option value="${e}">${e.toUpperCase()}</option>`).join(""),t.addEventListener("change",ne),a.appendChild(t)}else o.push(e)}),Y={fixedAbilities:o},ne()}catch(e){console.error("Errore caricando il talento:",e)}else updateFinalScores()}),E.appendChild(e),E.appendChild(t),E.appendChild(a)}y.appendChild(E),R(y),ee(y),X()}catch(e){handleError(`Errore caricando il background: ${e}`)}})});const ae=["Club","Crossbow, Light","Dagger","Dart","Greatclub","Handaxe","Javelin","Light Hammer","Mace","Quarterstaff","Shortbow","Sickle","Sling","Spear","Yklwa"];let ie=null;function le(){const e=document.getElementById("classSelect");return e&&e.selectedOptions.length?e.selectedOptions[0].text.trim().normalize("NFC"):""}function se(){if(!ie)return;const e=p().equipment||{class:[],upgrades:[]},t=le(),n=parseInt(document.getElementById("levelSelect").value||"1",10),o=document.getElementById("equipmentSelections");if(!o)return;o.innerHTML="";const a=document.getElementById("confirmEquipment");a&&(a.style.display="inline-block"),window.equipmentSelectionConfirmed=!1;const i=document.createElement("details");i.className="feature-block",i.innerHTML=`<summary>Standard Equipment</summary><ul>${ie.standard.map(e=>`<li>${e}</li>`).join("")}</ul>`,o.appendChild(i);const l=ie.classes[t];if(l){if(Array.isArray(l.fixed)&&l.fixed.length>0){const e=document.createElement("details");e.className="feature-block",e.innerHTML=`<summary>Fixed Equipment</summary><p>${l.fixed.join(", ")}</p>`,o.appendChild(e)}Array.isArray(l.choices)&&l.choices.forEach((t,n)=>{const a=document.createElement("details");a.className="feature-block needs-selection incomplete",a.innerHTML=`<summary>${t.label||"Choose"}</summary>`;const i=[];(t.options||[]).forEach(e=>{"simple weapon"===("string"==typeof e?e:e.label||e.value).toLowerCase()?i.push({value:"simple weapon",label:"Simple weapon",simpleWeapon:!0}):i.push("string"==typeof e?{value:e,label:e}:e)});if("radio"===t.type&&(i.length>5||/tools|instrument/i.test(t.label||""))&&!i.some(e=>e.simpleWeapon)){const t=document.createElement("select");t.name=`equipChoice_${n}`,t.id=`equipChoice_${n}`;const o=document.createElement("option");if(o.value="",o.textContent="-- select --",t.appendChild(o),i.forEach(e=>{const n=document.createElement("option");n.value=e.value||e,n.textContent=e.label||e,t.appendChild(n)}),e.class){const n=i.find(t=>e.class.includes(t.value||t));n&&(t.value=n.value||n)}a.appendChild(t),a.appendChild(document.createElement("br"))}else i.forEach((o,i)=>{const l=`equipChoice_${n}_${i}`;if(o.simpleWeapon){const t=document.createElement("input");t.type="radio",t.name=`equipChoice_${n}`,t.id=l;const i=(e.class||[]).find(e=>ae.includes(e));t.value=i||"",i&&(t.checked=!0);const s=document.createElement("label");s.htmlFor=l,s.textContent=o.label,a.appendChild(t),a.appendChild(s);const c=document.createElement("select"),r=document.createElement("option");r.value="",r.textContent="-- select --",c.appendChild(r),ae.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,c.appendChild(t)}),i&&(c.value=i),c.addEventListener("change",()=>{t.value=c.value,t.checked=!0}),a.appendChild(c),a.appendChild(document.createElement("br"))}else{const i=document.createElement("input");i.type="checkbox"===t.type?"checkbox":"radio",i.name=`equipChoice_${n}`,i.id=l,i.value=o.value||o,e.class&&e.class.includes(i.value)&&(i.checked=!0);const s=document.createElement("label");s.htmlFor=l,s.textContent=o.label||o,a.appendChild(i),a.appendChild(s),a.appendChild(document.createElement("br"))}});o.appendChild(a)})}else{const e=document.createElement("p");e.textContent="No specific equipment for this class.",o.appendChild(e)}if(ie.upgrades&&n>=(ie.upgrades.minLevel||0)){const t=ie.upgrades,n=document.createElement("details");if(n.className="feature-block",n.innerHTML="<summary>Advanced Options</summary>",Array.isArray(t.armor)){const o=document.createElement("p");o.innerHTML="<strong>Armor:</strong>",n.appendChild(o),t.armor.forEach((t,o)=>{const a=`upgradeArmor_${o}`,i=document.createElement("input");i.type="radio",i.name="upgradeArmor",i.id=a,i.value=t,e.upgrades&&e.upgrades.includes(i.value)&&(i.checked=!0);const l=document.createElement("label");l.htmlFor=a,l.textContent=t,n.appendChild(i),n.appendChild(l),n.appendChild(document.createElement("br"))})}if(t.weapon){const o="upgradeWeapon",a=document.createElement("input");a.type="checkbox",a.id=o,a.value=t.weapon,e.upgrades&&e.upgrades.includes(a.value)&&(a.checked=!0);const i=document.createElement("label");i.htmlFor=o,i.textContent=t.weapon,n.appendChild(a),n.appendChild(i)}o.appendChild(n)}T(o),o.classList.add("accordion"),M(o),o.querySelectorAll(".accordion-item.needs-selection").forEach(e=>{const t=()=>{const t=e.querySelectorAll("input:checked").length>0||Array.from(e.querySelectorAll("select")).some(e=>e.value);e.classList.toggle("incomplete",!t)};e.querySelectorAll("input, select").forEach(e=>e.addEventListener("change",t)),t(),e.querySelectorAll("input:checked, select").forEach(e=>e.dispatchEvent(new Event("change")))})}document.addEventListener("DOMContentLoaded",async()=>{if(!document.getElementById("step5"))return;try{const e=await fetch("data/equipment.json");if(!e.ok)throw new Error("Failed to load equipment data");const t=await e.json();ie=t,se();const n=document.getElementById("classSelect"),o=document.getElementById("levelSelect");n&&n.addEventListener("change",se),o&&o.addEventListener("change",se)}catch(e){console.error("Error loading equipment:",e)}const e=document.getElementById("confirmEquipment"),t=document.getElementById("equipmentSelections");e&&t&&e.addEventListener("click",()=>{const n=le(),o=ie.classes[n]||{fixed:[]},a=[];Array.isArray(o.fixed)&&a.push(...o.fixed);const i=[];if(t.querySelectorAll("input:checked").forEach(e=>{e.name&&e.name.startsWith("equipChoice_")?a.push(e.value):i.push(e.value)}),t.querySelectorAll("select").forEach(e=>{e.name&&e.name.startsWith("equipChoice_")?e.value&&a.push(e.value):e.value&&i.push(e.value)}),t.querySelector(".needs-selection.incomplete"))return void alert("⚠️ Seleziona tutte le opzioni di equipaggiamento prima di procedere!");p().equipment={standard:ie.standard,class:a,upgrades:i},m(),window.equipmentSelectionConfirmed=!0,e.style.display="none"})}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("step7");e&&(e.innerHTML='\n    <h2>Step 7: Riepilogo ed Esportazione</h2>\n    <div id="finalRecap"></div>\n    <button id="generateJson">Genera JSON</button>\n    \x3c!-- Puoi aggiungere qui anche il pulsante per esportare in PDF --\x3e\n  ')});let ce=!1,re=!1,de=!1;function ue(e,t,o,a){let i="";const{modalId:l,detailsId:s,closeId:c}=o;function r(){const e=document.getElementById(l);e&&e.classList.add("hidden")}if(async function(e,t,o){try{const a=await fetch(e);if(!a.ok)throw new Error("Network response was not ok");const i=await a.json();if(!i.items)return void n(`Chiave items non trovata in ${e}`);const l=document.getElementById(t);if(!l)return void n(`Elemento #${t} non trovato!`);Object.entries(i.items).forEach(([e,t])=>{const n=document.createElement("button");n.className="btn btn-primary",n.textContent=e,n.addEventListener("click",()=>o(e,t)),l.appendChild(n)})}catch(t){n(`Errore caricando ${e}: ${t}`)}}(e,t,async function(e,t){i=t;const n=document.getElementById(l),o=document.getElementById(s);if(n&&o){o.textContent="";try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();a(o,n)}catch(e){o.textContent="Errore caricando i dettagli."}n.classList.remove("hidden")}}),c){const e=document.getElementById(c);e&&e.addEventListener("click",r)}return{getPendingPath:()=>i,closeModal:r}}window.equipmentSelectionConfirmed=!1,window.racialBonusesConfirmed=!1,document.addEventListener("DOMContentLoaded",()=>{console.log("✅ Main.js caricato!");const i=["userName","characterName","origin","age"];function l(e){switch(e){case 0:return i.every(e=>document.getElementById(e)?.value.trim());case 1:return ce;case 2:return re;case 3:return de;case 4:return window.equipmentSelectionConfirmed;case 5:return 0===(parseInt(document.getElementById("pointsRemaining")?.textContent)||0)&&window.racialBonusesConfirmed;default:return!0}}t("data/races.json","raceSelect"),t("data/classes.json","classSelect");const s=ue("data/classes.json","classList",{modalId:"classModal",detailsId:"classModalDetails",closeId:"closeClassModal"},(e,t)=>{e.appendChild(o(t.name,3)),e.appendChild(a(t.description)),e.appendChild(a(`Hit Die: ${t.hit_die}`)),e.appendChild(a(`Saving Throws: ${t.saving_throws.join(", ")}`))}),c=ue("data/races.json","raceList",{modalId:"raceModal",detailsId:"raceModalDetails",closeId:"closeRaceModal"},(e,t)=>{e.appendChild(o(t.name,3))}),r=ue("data/backgrounds.json","backgroundList",{modalId:"backgroundModal",detailsId:"backgroundModalDetails",closeId:"closeBackgroundModal"},(e,t)=>{e.appendChild(o(t.name,3)),t.skills&&e.appendChild(a(`Abilità: ${t.skills.join(", ")}`)),t.tools&&t.tools.length&&e.appendChild(a(`Strumenti: ${t.tools.join(", ")}`))});["step1","step2","step3","step4","step5","step6","step7"].forEach((t,n)=>{const o=document.getElementById(`btnStep${n+1}`);o&&o.addEventListener("click",()=>{(function(e){for(let t=0;t<e;t++)if(!l(t))return alert(`Completa Step ${t+1} prima di procedere!`),!1;return!0})(n)&&(e(t),"step7"===t&&W())})});const d=document.getElementById("classSelect"),p=document.getElementById("levelSelect");d&&d.addEventListener("change",()=>{ce=!1,u={},m();const e=document.getElementById("confirmClassSelection");e&&(e.style.display="inline-block"),async function(){const e=document.getElementById("classSelect").value,t=document.getElementById("classFeatures");if(!e)return window.currentClassData=null,void(t&&(t.textContent="",t.appendChild(a("Seleziona una classe per vedere i tratti."))));try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const n=await t.json();window.currentClassData=n,q()}catch(e){n(`Errore caricando le sottoclasse: ${e}`)}}()}),p&&p.addEventListener("change",()=>{q()});const g=document.getElementById("raceSelect");g&&g.addEventListener("change",()=>{re=!1;const e=document.getElementById("confirmRaceSelection");e&&(e.style.display="inline-block"),D()});const h=document.getElementById("backgroundSelect");h&&h.addEventListener("change",()=>{de=!1;const e=document.getElementById("confirmBackgroundSelection");e&&(e.style.display="inline-block")}),["racialBonus1","racialBonus2","racialBonus3"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{window.racialBonusesConfirmed=!1})}),["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent="0");const n=document.getElementById(e+"BackgroundTalent");n&&(n.value="0")}),G();const f=(document.querySelectorAll("input, select, textarea").forEach(e=>{if(!e.id)return;const t=localStorage.getItem(e.id);null!==t&&("checkbox"===e.type||"radio"===e.type?e.checked="true"===t:e.value=t)}),localStorage.getItem("currentStep")),y={nameStep:"step1",classStep:"step2",raceStep:"step3",backgroundStep:"step4",equipmentStep:"step5",pointBuyStep:"step6",recapStep:"step7"}[f]||f;e(y||"step1"),"step7"===(y||"step1")&&W(),document.getElementById("levelSelect").addEventListener("change",()=>D()),document.getElementById("generateJson").addEventListener("click",V),document.getElementById("addClassButton").addEventListener("click",()=>{const e=document.getElementById("classSelect");e&&(e.value=s.getPendingPath(),e.dispatchEvent(new Event("change"))),s.closeModal()}),document.getElementById("addRaceButton").addEventListener("click",()=>{const e=document.getElementById("raceSelect");if(e){e.value=c.getPendingPath(),D();const t=document.getElementById("confirmRaceSelection");t&&(t.style.display="inline-block"),re=!1}c.closeModal()}),document.getElementById("addBackgroundButton").addEventListener("click",()=>{const e=document.getElementById("backgroundSelect");if(e){e.value=r.getPendingPath(),e.dispatchEvent(new Event("change"));const t=document.getElementById("confirmBackgroundSelection");t&&(t.style.display="inline-block"),de=!1}r.closeModal()}),document.getElementById("confirmClassSelection").addEventListener("click",async()=>{const e=document.getElementById("classSelect"),t=document.getElementById("subclassSelect"),n=parseInt(document.getElementById("levelSelect")?.value)||1;if(!e.value)return void alert("⚠️ Seleziona una classe prima di procedere!");if(document.querySelector("#classFeatures .needs-selection, #classExtrasAccordion .needs-selection"))return void alert("⚠️ Completa tutte le scelte della classe prima di procedere!");const o=e.selectedOptions[0]?.text||"";if(t&&n>=({Cleric:1,Warlock:1,Sorcerer:1}[o]||3)&&!t.value)return void alert("⚠️ Seleziona una sottoclasse prima di procedere!");ce=!0,await q();const a=document.getElementById("confirmClassSelection");a&&(a.style.display="none")}),document.getElementById("confirmRaceSelection").addEventListener("click",()=>{document.getElementById("raceSelect").value?document.querySelector("#raceTraits .needs-selection.incomplete")?alert("⚠️ Completa tutte le scelte della razza prima di procedere!"):(re=!0,document.getElementById("confirmRaceSelection").style.display="none"):alert("⚠️ Seleziona una razza prima di procedere!")}),document.getElementById("confirmBackgroundSelection").addEventListener("click",()=>{document.getElementById("backgroundSelect").value?document.querySelector("#step4 .needs-selection.incomplete")?alert("⚠️ Completa tutte le scelte del background prima di procedere!"):(de=!0,document.getElementById("confirmBackgroundSelection").style.display="none"):alert("⚠️ Seleziona un background prima di procedere!")})})}();

!function(){"use strict";function e(e){document.querySelectorAll("input, select, textarea").forEach(e=>{e.id&&("checkbox"===e.type||"radio"===e.type?localStorage.setItem(e.id,e.checked):localStorage.setItem(e.id,e.value))});document.querySelectorAll(".step").forEach(t=>{const n=t.id===e;t.classList.toggle("active",n),t.classList.toggle("hidden",!n)}),function(e){const t=document.getElementById("progressBar");if(!t)return;const n=Array.from(document.querySelectorAll(".step")),o=n.findIndex(t=>t.id===e),a=(o+1)/n.length*100;t.style.width=`${a}%`}(e),localStorage.setItem("currentStep",e)}async function t(e,t,n){try{const a=await fetch(e);if(!a.ok)throw new Error("Network response was not ok");const i=await a.json();if(console.log(`📜 Dati ricevuti da ${e}:`,i),!i[n])return void o(`Chiave ${n} non trovata in ${e}`);!function(e,t){const n=document.getElementById(e);if(!n)return void o(`Elemento #${e} non trovato!`);n.innerHTML='<option value="">Seleziona...</option>',t.forEach(e=>{const t=document.createElement("option");t.value=e.path,t.textContent=e.name,n.appendChild(t)})}(t,Object.keys(i[n]).map(e=>({name:e,path:i[n][e]})))}catch(t){o(`Errore caricando ${e}: ${t}`)}}async function n(e,t,n,a){try{const i=await fetch(e);if(!i.ok)throw new Error("Network response was not ok");const l=await i.json();if(!l[t])return void o(`Chiave ${t} non trovata in ${e}`);const s=document.getElementById(n);if(!s)return void o(`Elemento #${n} non trovato!`);Object.entries(l[t]).forEach(([e,t])=>{const n=document.createElement("button");n.className="btn btn-primary",n.textContent=e,n.addEventListener("click",()=>a(e,t)),s.appendChild(n)})}catch(t){o(`Errore caricando ${e}: ${t}`)}}function o(e){console.error("❌ "+e),alert("⚠️ "+e)}function a(e,t=3){const n=document.createElement(`h${t}`);return n.textContent=e,n}function i(e){const t=document.createElement("p");return t.textContent=e,t}async function l(e){try{const t=await fetch("data/spells.json");if(!t.ok)throw new Error("Failed to load spells");const n=await t.json();console.log("📖 Spells loaded:",n),e(n)}catch(e){console.error("❌ Error loading spells:",e)}}window.resetForm=function(){if(!confirm("Reset all character data?"))return;localStorage.clear(),document.querySelectorAll("input, select, textarea").forEach(e=>{"checkbox"===e.type||"radio"===e.type?e.checked=!1:"select"===e.tagName.toLowerCase()?e.selectedIndex=0:e.value=""}),document.querySelectorAll(".step").forEach((e,t)=>{const n=0===t;e.classList.toggle("active",n),e.classList.toggle("hidden",!n)});const e=document.getElementById("progressBar");e&&(e.style.width="0%")};const s=["Alchemist's Supplies","Brewer's Supplies","Calligrapher's Tools","Carpenter's Tools","Cartographer's Tools","Cobbler's Tools","Cook's Utensils","Glassblower's Tools","Jeweler's Tools","Leatherworker's Tools","Mason's Tools","Painter's Supplies","Potter's Tools","Smith's Tools","Tinker's Tools","Weaver's Tools","Woodcarver's Tools","Bagpipes","Drum","Dulcimer","Flute","Lute","Lyre","Horn","Pan Flute","Shawm","Viol","Disguise Kit","Forgery Kit","Herbalism Kit","Navigator's Tools","Poisoner's Kit","Thieves' Tools","Dice Set","Dragonchess Set","Playing Card Set","Three-Dragon Ante Set","Vehicle (Land)","Vehicle (Water)"],c=["Common","Dwarvish","Elvish","Giant","Gnomish","Goblin","Halfling","Orc","Abyssal","Celestial","Draconic","Deep Speech","Infernal","Primordial","Sylvan","Undercommon"],r=["Acrobatics","Animal Handling","Arcana","Athletics","Deception","History","Insight","Intimidation","Investigation","Medicine","Nature","Perception","Performance","Persuasion","Religion","Sleight of Hand","Stealth","Survival"];function d(e,t,n,o=[]){const a={languages:c,skills:r,tools:s},i={languages:" (tutte le lingue disponibili)",skills:" (tutte le abilità disponibili)",tools:" (tutti gli strumenti disponibili)"},l=o.map(e=>e.toLowerCase());let d=t.filter(e=>!n.has(e.toLowerCase())||l.includes(e.toLowerCase()));return 0===d.length?(d=(a[e]||[]).filter(e=>!n.has(e.toLowerCase())||l.includes(e.toLowerCase())),{options:d,note:i[e]||""}):{options:d,note:""}}function u(e){return Array.isArray(e)?e.map(e=>"string"==typeof e?e:e.entries?u(e.entries):e.items?u(e.items):"").join(" "):""}let p=sessionStorage.getItem("selectedData")?JSON.parse(sessionStorage.getItem("selectedData")):{};function m(){return p}function g(){sessionStorage.setItem("selectedData",JSON.stringify(p))}function h(e,t,n,o,a){const i=[];for(let a=0;a<t;a++){const t=document.createElement("select");t.className=o,t.dataset.options=JSON.stringify(n),e.appendChild(t),i.push(t)}const l=()=>{const e=new Set(i.map(e=>e.value).filter(Boolean));i.forEach(t=>{const n=JSON.parse(t.dataset.options),o=t.value;t.innerHTML='<option value="">Seleziona</option>'+n.map(t=>`<option value="${t}" ${e.has(t)&&t!==o?"disabled":""}>${t}</option>`).join(""),t.value=o}),a&&a()};return i.forEach(e=>e.addEventListener("change",l)),l(),i}const f={"Drow Magic":{type:"none"},"Skill Versatility":{type:"skills",count:2,options:r},Swim:{type:"none"},"Cantrip (Wizard)":{type:"spells",filter:"level=0|class=Wizard"}};function y(){const e=document.getElementById("variantFeatureChoice"),t=document.getElementById("variantExtraContainer");if(!t||!e||!e.value)return;const n=e.value,o=f[n];if(t.innerHTML="",o)if("skills"===o.type){t.innerHTML=`<p><strong>Seleziona ${o.count} skill per ${n}:</strong></p>`;const e=()=>{m()["Variant Feature Skills"]=[...t.querySelectorAll(".variantSkillChoice")].map(e=>e.value).filter(Boolean),g(),P("variantFeatureTrait")};h(t,o.count,o.options,"variantSkillChoice",e)}else"spells"===o.type&&l(e=>{const a=function(e,t){const n=t.split("|");return e.filter(e=>{let t=!0;return n.forEach(n=>{const o=n.split("=");if(2===o.length){const n=o[0].trim().toLowerCase(),a=o[1].trim().toLowerCase();"level"===n?parseInt(e.level)!==parseInt(a)&&(t=!1):"class"===n&&(e.spell_list&&e.spell_list.map(e=>e.toLowerCase()).includes(a)||(t=!1))}}),t})}(e,o.filter);t.innerHTML=a.length?`<p><strong>Seleziona un incantesimo per ${n}:</strong></p>\n            <select id="variantSpellChoice">\n              <option value="">Seleziona...</option>\n              ${a.map(e=>`<option value="${e.name}">${e.name}</option>`).join("")}\n            </select>`:`<p>Nessun incantesimo trovato per il filtro: ${o.filter}</p>`;const i=document.getElementById("variantSpellChoice");i&&(i.addEventListener("change",()=>{m()["Variant Feature Spell"]=[i.value],g(),P("variantFeatureTrait")}),P("variantFeatureTrait"))})}let E=[],C=0;function v(){return E}function k(e){E=e}function S(){return C}function b(e){C=e}const w={Cantrip:"Cantrips",Cantrips:"Cantrips","Skill Proficiency":"Skill Proficiency","Tool Proficiency":"Tool Proficiency","Fighting Style":"Fighting Style","Additional Fighting Style":"Fighting Style","Divine Domain":"Divine Domain",Metamagic:"Metamagic"},L={Cantrips:"Scegli i tuoi cantrip.","Skill Proficiency":"Seleziona le competenze nelle abilità.","Tool Proficiency":"Seleziona le competenze negli strumenti.","Fighting Style":"Scegli il tuo stile di combattimento.","Divine Domain":"Seleziona il tuo dominio divino.",Metamagic:"Scegli le opzioni di Metamagia."};let x=m();const B=document.getElementById("prevTrait"),I=document.getElementById("nextTrait"),$=document.getElementById("closeModal");function A(){x=m();const e=v();if(Object.entries({Languages:["languageSelection","Lingue Extra"],"Skill Proficiency":["skillSelectionContainer","Skill Proficiency"],"Tool Proficiency":["toolSelectionContainer","Tool Proficiency"]}).forEach(([e,[t,n]])=>{if(void 0!==x[e])!function(e,t,n){const o=document.getElementById(e);if(!o)return;const a=(x[n]||[]).filter(e=>e);a.length>0?(o.innerHTML=`<p><strong>${t}:</strong> ${a.join(", ")}</p>`,o.classList.remove("hidden")):(o.innerHTML="",o.classList.add("hidden"))}(t,n,e);else{const e=document.getElementById(t);e&&e.classList.add("hidden")}}),!e||0===e.length)return;const t=document.getElementById("extraSelectionTitle"),n=document.getElementById("extraSelectionDescription"),o=document.getElementById("extraSelectionContainer");if(!t||!n||!o)return;const a=e[S()];t.innerText=a.name;const i=a.description||L[a.name]||"";if(n.innerText=i,o.innerHTML="",a.selection){const e=w[a.name]||a.name,t=H({Languages:"languages","Skill Proficiency":"skills","Tool Proficiency":"tools",Cantrips:"cantrips"}[e]||""),n=(x[e]||[]).filter(e=>e).map(e=>e.toLowerCase()),i=new Set(n);t.forEach(e=>i.add(e));let l="";for(let t=0;t<a.count;t++)l+=`<select class="extra-selection" data-category="${e}" data-index="${t}"><option value="">Seleziona...</option>`,a.selection.forEach(e=>{const t=e.toLowerCase(),o=i.has(t)&&!n.includes(t);l+=`<option value="${e}" ${o?"disabled":""}>${e}</option>`}),l+="</select><br>";o.innerHTML=l,document.querySelectorAll(".extra-selection").forEach(e=>{e.addEventListener("change",e=>{const t=e.target.getAttribute("data-category"),n=w[t]||t,o=e.target.getAttribute("data-index");x[n]||(x[n]=[]),x[n][o]=e.target.value,g(),A()})})}if(B&&I&&$){const t=S();B.disabled=0===t,I.disabled=t===e.length-1;const n=e.every(e=>x[e.name]&&x[e.name].filter(e=>e).length===e.count);t===e.length-1&&n?$.style.display="inline-block":$.style.display="none"}}function _(){const e=v();e&&0!==e.length&&A()}function T(e){e&&e.querySelectorAll("details").forEach(e=>{const t=e.querySelector("summary"),n=Array.from(e.childNodes).filter(e=>e!==t),o=document.createElement("div"),a=["accordion-item","feature-block",...e.classList];o.className=a.join(" "),e.id&&(o.id=e.id);const i=document.createElement("button");i.type="button",i.className="accordion-header",i.innerHTML=t?t.innerHTML:"",o.appendChild(i);const l=document.createElement("div");l.className="accordion-content",n.forEach(e=>l.appendChild(e)),o.appendChild(l),e.replaceWith(o)})}function M(e){e&&e.querySelectorAll(".accordion-header").forEach((e,t)=>{const n=e.nextElementSibling;if(e.setAttribute("role","button"),e.hasAttribute("tabindex")||e.setAttribute("tabindex","0"),e.setAttribute("aria-expanded","false"),n){const o=e.id||`accordion-header-${t}`;e.id=o,n.setAttribute("role","region"),n.setAttribute("aria-labelledby",o)}const o=()=>{const t="true"===e.getAttribute("aria-expanded");e.setAttribute("aria-expanded",String(!t)),e.classList.toggle("active",!t),n&&n.classList.toggle("show",!t),e.focus()};e.addEventListener("click",o),e.addEventListener("keydown",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),o())})})}async function D(){console.log("🛠 Esecuzione displayRaceTraits()...");const e=m(),t=document.getElementById("raceSelect").value,n=document.getElementById("raceTraits"),d=document.getElementById("racialBonusSelection");if(!t)return console.warn("⚠️ displayRaceTraits(): Nessuna razza selezionata."),n.textContent="",n.appendChild(i("Seleziona una razza per vedere i tratti.")),d.style.display="none",void K();console.log(`📜 Caricamento tratti per ${t}...`);try{const o=await fetch(t);if(!o.ok)throw new Error("Network response was not ok");const d=await o.json();console.log("📜 Dati razza caricati:",d);const p=function(e){let t="Unknown";t=Array.isArray(e.size)?"M"===e.size[0]?"Medium":"S"===e.size[0]?"Small":e.size[0]:e.size||"Unknown";let n={};if(e.speed)if("object"==typeof e.speed)for(let t in e.speed)n[t]="boolean"==typeof e.speed[t]?"fly"===t?"equal to your walking speed":"unknown":e.speed[t];else n=e.speed;let o={};e.senses&&"object"==typeof e.senses?o=e.senses:e.darkvision&&(o.darkvision=e.darkvision);let a={options:[]};e.ability&&Array.isArray(e.ability)&&e.ability.forEach(e=>{if(e.choose&&e.choose.weighted){const t=e.choose.weighted.weights;2===t.length&&t.includes(2)?a.options.push({type:"fixed",values:{any:2,any_other:1}}):3===t.length&&a.options.push({type:"three",values:{any:1,any_other:1,any_other_2:1}})}});let i=null,l=[];const s=e.entries||[];s.forEach(e=>{if("inset"===e.type&&e.name&&e.name.toLowerCase().includes("variant feature")){i=(e.entries||[]).map(e=>({name:e.name,description:u(e.entries)}));const t=i.map(e=>`<strong>${e.name}:</strong> ${e.description}`).join(" ");l.push({name:e.name,description:t,level_requirement:1})}else e.name&&e.entries&&l.push({name:e.name,description:u(e.entries),level_requirement:e.level||1})});let c={fixed:[],choice:0,options:[]};if(e.languageProficiencies&&e.languageProficiencies.length>0){const t=e.languageProficiencies[0];for(let e in t)!0===t[e]?c.fixed.push(e.charAt(0).toUpperCase()+e.slice(1)):"number"==typeof t[e]&&(c.choice=t[e]);c.choice>0&&0===c.options.length&&c.options.push("Any other language you and your DM agree is appropriate")}let d=null;if(e.skillProficiencies&&e.skillProficiencies.length>0){const t=e.skillProficiencies[0];t.choose&&t.choose.from?d={number:t.choose.count?t.choose.count:1,options:t.choose.from}:"number"==typeof t.any&&(d={number:t.any,options:r})}let p=null;e.toolProficiencies&&Array.isArray(e.toolProficiencies)&&e.toolProficiencies.forEach(e=>{e.choose&&e.choose.from&&(p={number:1,options:e.choose.from})});let m=null;if(e.additionalSpells&&e.additionalSpells.length>0){const t=e.additionalSpells[0];if(m={},t.ability){let e=[];e=Array.isArray(t.ability)?t.ability:"object"==typeof t.ability&&t.ability.choose?Array.isArray(t.ability.choose)?t.ability.choose:[t.ability.choose]:[t.ability],m.ability_choices=e.map(e=>e.toString().toUpperCase())}if(t.known){const e=[];Object.values(t.known).forEach(t=>{(t._||[]).forEach(t=>{"string"==typeof t?e.push(t):t.choose&&(m.spell_choices={type:"filter",filter:t.choose})})}),!m.spell_choices&&e.length>1?m.spell_choices={type:"fixed_list",options:e}:1===e.length&&(m.fixed_spell=e[0])}}return{name:e.name,source:e.source+(e.page?`, page ${e.page}`:""),size:t,speed:n,senses:o,ability_bonus:a,traits:l,rawEntries:s,spellcasting:m,languages:c,skill_choices:d,tool_choices:p,variant_feature_choices:i}}(d);window.currentRaceData=p,n.textContent="",n.appendChild(a(`Tratti di ${p.name}`,3));let g="Velocità: Non disponibile";if(p.speed)if("object"==typeof p.speed){g=`Velocità: ${Object.entries(p.speed).map(([e,t])=>`${e}: ${t} ft`).join(", ")}`}else g=`Velocità: ${p.speed} ft`;n.appendChild(i(g)),p.senses&&p.senses.darkvision&&n.appendChild(i(`Visione: ${p.senses.darkvision} ft`));let h=null;p.traits&&p.traits.length>0&&(n.appendChild(a("Tratti:",4)),p.traits.forEach(t=>{const o=`trait-${t.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")}`,a=t.name,i=document.createElement("details");i.className="race-trait feature-block",i.id=o;const l=document.createElement("summary");l.textContent=t.name,i.appendChild(l);const s=document.createElement("div");s.className="feature-desc",s.textContent=t.description||"",i.appendChild(s);const c=t.choices||t.variant_feature_choices;c&&c.forEach((t,n)=>{const o=t.options||t.selection||[],l=e[a]?.[n]||"",s=document.createElement("label");s.textContent=(t.name||"Scegli")+": ";const c=document.createElement("select");c.dataset.feature=a,c.dataset.index=n;const r=document.createElement("option");r.value="",r.textContent="Seleziona...",c.appendChild(r),o.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l===e&&(t.selected=!0),c.appendChild(t)}),s.appendChild(c),i.appendChild(s)}),t.name.toLowerCase().includes("cantrip")&&(h=i),n.appendChild(i)}));const f=O(p,"race");k(f);const E={Languages:/language/i,"Skill Proficiency":/skill/i,"Tool Proficiency":/tool/i};f.forEach((t,o)=>{const a=w[t.name]||t.name;let i=null;const l=E[t.name];if(l&&(i=Array.from(n.querySelectorAll("details")).find(e=>l.test(e.querySelector("summary")?.textContent||""))),!i){i=document.createElement("details"),i.className="race-trait feature-block",i.id=`race-extra-${o}`;const e=document.createElement("summary");e.textContent=t.name,i.appendChild(e),n.appendChild(i)}if(t.description&&!i.querySelector(".feature-desc")){const e=document.createElement("div");e.className="feature-desc",e.textContent=t.description,i.appendChild(e)}const s=t.selection||[],c=t.count||1;for(let n=0;n<c;n++){const o=e[a]?.[n]||"",l=document.createElement("label");l.textContent=`${t.name}${c>1?" "+(n+1):""}: `;const r=document.createElement("select");r.dataset.feature=a,r.dataset.index=n;const d=document.createElement("option");d.value="",d.textContent="Seleziona...",r.appendChild(d),s.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,o===e&&(t.selected=!0),r.appendChild(t)}),l.appendChild(r),i.appendChild(l)}});const C=(t,o,a,i,l)=>{if(!o||0===o.length)return;const{taken:s,conflicts:c}=F(t,o);if(!c.length)return;let r=Array.from(n.querySelectorAll("details")).find(e=>l.test(e.querySelector("summary")?.textContent||""));if(!r){r=document.createElement("details"),r.className="race-trait feature-block";const e=document.createElement("summary");e.textContent=i,r.appendChild(e),n.appendChild(r)}const d=r.querySelectorAll(`select[data-feature="${i}"]`).length,u=a.filter(e=>!s.has(e.toLowerCase())),p=[],m=document.createElement("p");m.innerHTML=`<strong>${{Languages:"Linguaggi","Skill Proficiency":"Abilità","Tool Proficiency":"Strumenti"}[i]} duplicate, scegli sostituti:</strong>`,r.appendChild(m),c.forEach((t,n)=>{const o=document.createElement("label");o.textContent=`${t}: `;const a=document.createElement("select");a.dataset.feature=i,a.dataset.index=d+n;const l=document.createElement("option");l.value="",l.textContent="Seleziona...",a.appendChild(l),u.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)});const s=e[i]?.[d+n]||"";s&&(a.value=s),o.appendChild(a),r.appendChild(o),p.push(a)});const g=()=>{const e=new Set(p.map(e=>e.value).filter(Boolean));p.forEach(t=>{const n=t.value;t.innerHTML='<option value="">Seleziona...</option>'+u.map(t=>`<option value="${t}" ${e.has(t)&&t!==n?"disabled":""}>${t}</option>`).join(""),t.value=n})};p.forEach(e=>e.addEventListener("change",g)),g()};if(C("languages",p.languages?.fixed,c,"Languages",/language/i),C("skills",p.skill_choices?.fixed,r,"Skill Proficiency",/skill/i),C("tools",p.tool_choices?.fixed,s,"Tool Proficiency",/tool/i),p.variant_feature_choices){const e=document.createElement("details");e.className="race-trait feature-block needs-selection incomplete",e.id="variantFeatureTrait";const t=document.createElement("summary");t.textContent="Variant Feature",e.appendChild(t);const o=document.createElement("div");o.id="variantFeatureSelectionContainer",e.appendChild(o);const a=document.createElement("div");a.id="variantExtraContainer",e.appendChild(a),n.appendChild(e)}const v=document.createElement("details");v.className="race-trait feature-block needs-selection incomplete hidden",v.id="ancestryTrait";const S=document.createElement("summary");S.textContent="Ancestry",v.appendChild(S);const b=document.createElement("div");b.id="ancestrySelectionContainer",v.appendChild(b),n.appendChild(v);const L=function(e){let t="";return e&&Array.isArray(e)?(e.forEach(e=>{e.entries&&Array.isArray(e.entries)&&e.entries.forEach(n=>{if("object"==typeof n&&"table"===n.type){if(t+='<div class="table-container" style="margin-top:1em; margin-bottom:1em;">',n.caption&&(t+=`<p><strong>${n.caption}</strong></p>`),t+='<table border="1" style="width:100%; border-collapse: collapse;">',n.colLabels&&Array.isArray(n.colLabels)&&(t+="<thead><tr>",n.colLabels.forEach(e=>{t+=`<th style="padding: 0.5em; text-align: center;">${e}</th>`}),t+="</tr></thead>"),n.rows&&Array.isArray(n.rows)&&(t+="<tbody>",n.rows.forEach(e=>{t+="<tr>",e.forEach(e=>{t+=`<td style="padding: 0.5em; text-align: center;">${e}</td>`}),t+="</tr>"}),t+="</tbody>"),t+="</table>",e.name&&e.name.toLowerCase().includes("ancestry")){let e='<option value="">Seleziona...</option>';n.rows.forEach(t=>{const n=JSON.stringify(t),o=`${t[0]} (${t[1]})`;e+=`<option value='${n}'>${o}</option>`}),t+=`<p><strong>Seleziona Ancestry:</strong>\n                      <select id="ancestrySelect">${e}</select>\n                     </p>`}t+="</div>"}})}),t):t}(p.rawEntries);if(L){const e=document.createElement("div");e.appendChild(document.createRange().createContextualFragment(L)),n.appendChild(e)}await function(e,t){return new Promise(n=>{const o="string"==typeof t?document.getElementById(t):t;if(!o||!e.spellcasting)return void n();if(console.log(`🔍 JSON Spellcasting per ${e.name}:`,e.spellcasting),e.spellcasting.fixed_spell){const t=document.createElement("p");t.innerHTML=`<strong>✨ Assigned spell:</strong> ${e.spellcasting.fixed_spell}`,o.appendChild(t)}const a=()=>{if(e.spellcasting.ability_choices&&Array.isArray(e.spellcasting.ability_choices)&&(console.log(`🧙‍♂️ Checking casting ability for ${e.name}:`,e.spellcasting.ability_choices),e.spellcasting.ability_choices.length>1)){const t=e.spellcasting.ability_choices.map(e=>`<option value="${e.toUpperCase()}">${e.toUpperCase()}</option>`).join(""),n=document.createElement("div");n.innerHTML=`\n            <p><strong>🧠 Select the casting ability:</strong></p>\n            <select id="castingAbility">\n              <option value="">Select...</option>${t}\n            </select>`,o.appendChild(n)}n()};if(e.spellcasting.spell_choices)if("fixed_list"===e.spellcasting.spell_choices.type){const t=e.spellcasting.spell_choices.options.map(e=>`<option value="${e}">${e}</option>`).join(""),n=document.createElement("div");n.innerHTML=`\n          <p><strong>🔮 Choose a spell:</strong></p>\n          <select id="spellSelection">\n            <option value="">Select...</option>${t}\n          </select>`,o.appendChild(n),a()}else if("filter"===e.spellcasting.spell_choices.type){const t=e.spellcasting.spell_choices.filter.split("|"),n=t.find(e=>e.startsWith("level="))?.split("=")[1],i=t.find(e=>e.startsWith("class="))?.split("=")[1];if(n&&i)l(e=>{const t=H("cantrips"),l=e.filter(e=>parseInt(e.level)===parseInt(n)&&e.spell_list.includes(i)&&!t.has(e.name.toLowerCase())).map(e=>`<option value="${e.name}">${e.name}</option>`).join(""),s=document.createElement("div");s.innerHTML=l?`\n                <p><strong>🔮 Choose a ${i} Cantrip:</strong></p>\n                <select id="spellSelection">\n                  <option value="">Select...</option>${l}\n                </select>`:`<p><strong>⚠️ No Cantrip available for ${i}.</strong></p>`,o.appendChild(s),a()});else{const e=document.createElement("p");e.innerHTML="<strong>⚠️ Error: Spell filter is not valid for this race.</strong>",o.appendChild(e),a()}}else a();else a()})}(p,h),function(e){if(!e.variant_feature_choices)return;const t=document.getElementById("variantFeatureSelectionContainer");if(!t)return;let n='<p><strong>Scegli una Variant Feature:</strong></p><select id="variantFeatureChoice">\n                <option value="">Seleziona...</option>';e.variant_feature_choices.forEach(e=>{n+=`<option value="${e.name}">${e.name}</option>`}),n+="</select>",t.innerHTML=n,document.getElementById("variantFeatureChoice").addEventListener("change",y)}(p),function(e,t){if(e.variant_feature_choices&&e.variant_feature_choices.length>0){const n=e.variant_feature_choices.filter(e=>e.name.toLowerCase().includes("ancestry"));if(n.length>0){let e='<h4>Seleziona Ancestry</h4>\n                  <select id="ancestrySelection">\n                    <option value="">Seleziona...</option>';n.forEach(t=>{e+=`<option value="${t.name}">${t.name}</option>`}),e+="</select>";const o=document.getElementById(t);o&&(o.innerHTML=e)}}else{const e=document.getElementById(t);e&&(e.innerHTML="")}}(p,"ancestrySelectionContainer"),T(n),n.classList.add("accordion"),n.style.display="block",R(n,J),M(n);const x=document.getElementById("ancestryTrait");if(x){const e=document.getElementById("ancestrySelectionContainer");e&&""!==e.innerHTML.trim()&&x.classList.remove("hidden")}const B=document.getElementById("variantFeatureChoice");B&&(B.addEventListener("change",()=>{m()["Variant Feature"]=[B.value],y(),P("variantFeatureTrait")}),P("variantFeatureTrait"));const I=document.getElementById("ancestrySelection");I&&(I.addEventListener("change",()=>{m().Ancestry=[I.value],P("ancestryTrait")}),P("ancestryTrait")),K()}catch(e){o(`Errore caricando i tratti della razza: ${e}`)}}B&&I&&(B.addEventListener("click",()=>{const e=S();e>0&&(b(e-1),_())}),I.addEventListener("click",()=>{const e=S();e<v().length-1&&(b(e+1),_())})),$&&$.addEventListener("click",()=>{const e=document.getElementById("raceExtrasModal");e&&e.classList.add("hidden"),sessionStorage.removeItem("popupOpened"),g()}),A();const j=document.getElementById("raceSelect");async function z(){const e=document.getElementById("classFeatures"),t=window.currentClassData;if(!e)return;if(!t)return e.textContent="",void e.appendChild(i("Seleziona una classe per vedere i tratti."));const n=m(),o=parseInt(document.getElementById("levelSelect")?.value)||1,l=document.getElementById("subclassSelect")?.value||"";e.textContent="",e.appendChild(a(t.name,3)),t.description&&e.appendChild(i(t.description));const d=[],u=t.tool_proficiencies&&!Array.isArray(t.tool_proficiencies)?t.tool_proficiencies:null;let p=[];if(Array.isArray(t.tool_proficiencies)?p=t.tool_proficiencies.filter(e=>{const t=e.toLowerCase();return!t.includes("of your choice")&&!t.includes(" or ")}):t.tool_proficiencies?.fixed&&(p=t.tool_proficiencies.fixed),t.weapon_proficiencies&&d.push(`Weapon Training: ${t.weapon_proficiencies.join(", ")}`),t.armor_proficiencies&&d.push(`Armor Training: ${t.armor_proficiencies.join(", ")}`),p.length&&d.push(`Tool Proficiencies: ${p.join(", ")}`),t.skill_proficiencies&&t.skill_proficiencies.choose&&d.push(`Skill Proficiencies: Choose ${t.skill_proficiencies.choose} from ${t.skill_proficiencies.options.join(", ")}`),t.skill_proficiencies&&Array.isArray(t.skill_proficiencies.fixed)&&t.skill_proficiencies.fixed.length&&d.push(`Skill Proficiencies: ${t.skill_proficiencies.fixed.join(", ")}`),t.language_proficiencies&&Array.isArray(t.language_proficiencies.fixed)&&t.language_proficiencies.fixed.length&&d.push(`Languages: ${t.language_proficiencies.fixed.join(", ")}`),t.multiclassing&&t.multiclassing.prerequisites){const e=Object.entries(t.multiclassing.prerequisites).map(([e,t])=>`${e} ${t}`).join(", ");d.push(`Multiclassing Prerequisite: ${e}`)}if(d.length){const o=document.createElement("details");o.className="feature-block";const a=document.createElement("summary");a.textContent="Proficiencies",o.appendChild(a),d.forEach(e=>o.appendChild(i(e)));const l=(e,t,a,i,l)=>{if(!t||0===t.length)return;const{taken:s,conflicts:c}=F(e,t);if(!c.length)return;const r=o.querySelectorAll(`select[data-feature="${i}"]`).length,d=a.filter(e=>!s.has(e.toLowerCase())),u=[],p=document.createElement("p");p.innerHTML=`<strong>${l} duplicate, scegli sostituti:</strong>`,o.appendChild(p),c.forEach((e,t)=>{const a=document.createElement("label");a.textContent=`${e}: `;const l=document.createElement("select");l.dataset.feature=i,l.dataset.index=r+t;const s=document.createElement("option");s.value="",s.textContent="Seleziona...",l.appendChild(s),d.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l.appendChild(t)});const c=n[i]?.[r+t]||"";c&&(l.value=c),a.appendChild(l),o.appendChild(a),u.push(l)});const m=()=>{const e=new Set(u.map(e=>e.value).filter(Boolean));u.forEach(t=>{const n=t.value;t.innerHTML='<option value="">Seleziona...</option>'+d.map(t=>`<option value="${t}" ${e.has(t)&&t!==n?"disabled":""}>${t}</option>`).join(""),t.value=n})};u.forEach(e=>e.addEventListener("change",m)),m()};l("languages",t.language_proficiencies?.fixed,c,"Languages","Linguaggi"),l("skills",t.skill_proficiencies?.fixed,r,"Skill Proficiency","Abilità"),l("tools",p,s,"Tool Proficiency","Strumenti"),e.appendChild(o)}if(t.subclasses&&t.subclasses.length>0){const n=document.createElement("details");n.className="feature-block",n.id="subclassTrait";const o=document.createElement("summary");o.textContent="Sottoclasse",n.appendChild(o);const a=document.createElement("select");a.id="subclassSelect",a.className="form-control";const i=document.createElement("option");i.value="",i.textContent="Seleziona una sottoclasse",a.appendChild(i),t.subclasses.forEach(e=>{const t=document.createElement("option");t.value=e.name,t.textContent=e.name,l===e.name&&(t.selected=!0),a.appendChild(t)}),n.appendChild(a),e.appendChild(n)}let g=null;if(l)try{const t=function(e){let t=e.toLowerCase();t.startsWith("college of ")?t="college_of_"+t.slice(11):t.startsWith("circle of the ")?t="circle_of_the_"+t.slice(14):t.startsWith("circle of ")?t="circle_of_"+t.slice(10):(t=t.replace(/^(path|oath|way|school) of the /,"").replace(/^(path|oath|way|school) of /,"").replace(/^the /,""),t.endsWith(" domain")&&(t=t.slice(0,-7)));let n=t.replace(/ /g,"_")+".json";return"wild_magic.json"===n&&"Barbarian"===window.currentClassData?.name&&(n="barbarian_wild_magic.json"),n}(l),n=await fetch(`data/subclasses/${t}`);if(!n.ok)throw new Error("Network response was not ok");g=await n.json(),g.description&&e.appendChild(i(g.description))}catch(t){e.appendChild(i("Dettagli della sottoclasse non disponibili."))}else e.appendChild(i("Seleziona una sottoclasse per vedere i tratti."));const h={};t.features_by_level&&Object.entries(t.features_by_level).forEach(([e,t])=>{h[e]=[...t]}),g?.features_by_level&&Object.entries(g.features_by_level).forEach(([e,t])=>{h[e]||(h[e]=[]),h[e].push(...t)});Object.keys(h).sort((e,t)=>e-t).forEach(t=>{parseInt(t)<=o&&(e.appendChild(a(`Livello ${t}`,4)),h[t].forEach((o,a)=>{if("string"==typeof o){const t=document.createElement("details");t.className="feature-block";const n=document.createElement("summary");n.textContent=o,t.appendChild(n),e.appendChild(t)}else{const i=document.createElement("details");i.className="feature-block",i.id=`class-feature-${t}-${a}`;const l=document.createElement("summary");if(l.textContent=o.name,i.appendChild(l),o.description){const e=document.createElement("div");e.className="feature-desc",e.textContent=o.description,i.appendChild(e)}const s=o.choices||o.variant_feature_choices;s&&s.forEach((e,t)=>{const a=e.options||e.selection||[],l=n[o.name]?.[t]||"",s=document.createElement("label");s.textContent=(e.name||"Scegli")+": ";const c=document.createElement("select");c.dataset.feature=o.name,c.dataset.index=t;const r=document.createElement("option");r.value="",r.textContent="Seleziona...",c.appendChild(r),a.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,l===e&&(t.selected=!0),c.appendChild(t)}),s.appendChild(c),i.appendChild(s)}),e.appendChild(i)}}))});const f=[...t.choices||[],...g?.choices||[]];u&&!f.some(e=>"Tool Proficiency"===e.name)&&f.push({level:1,name:"Tool Proficiency",description:`Choose ${u.choose} from the class options`,count:u.choose,selection:u.options}),t.skill_proficiencies&&!f.some(e=>"Skill Proficiency"===e.name)&&f.push({level:1,name:"Skill Proficiency",description:`Choose ${t.skill_proficiencies.choose} from the class skill list`,count:t.skill_proficiencies.choose,selection:t.skill_proficiencies.options});const y=O({choices:f},"class",o);k(y);const E={Languages:/Proficiencies/i,"Skill Proficiency":/Proficiencies/i,"Tool Proficiency":/Proficiencies/i};y.forEach(t=>{const o=w[t.name]||t.name,a=Array.from(e.querySelectorAll("details"));let i=a.find(e=>{const n=e.querySelector("summary")?.textContent||"";return n===t.name||n===o});if(!i){const e=E[t.name]||E[o];e&&(i=a.find(t=>e.test(t.querySelector("summary")?.textContent||"")))}if(!i){i=document.createElement("details"),i.className="feature-block";const n=document.createElement("summary");n.textContent=t.name,i.appendChild(n),e.appendChild(i)}if(t.description&&!i.querySelector(".feature-desc")){const e=document.createElement("div");e.className="feature-desc",e.textContent=t.description,i.appendChild(e)}const l=t.options||t.selection||[],s=[];for(let e=0;e<(t.count||1);e++){const a=t.selected?.[e]||n[o]?.[e]||"",c=document.createElement("label");c.textContent=`${t.name}${t.count>1?" "+(e+1):""}: `;const r=document.createElement("select");r.dataset.feature=o,r.dataset.index=e,r.dataset.options=JSON.stringify(l);const d=document.createElement("option");d.value="",d.textContent="Seleziona...",r.appendChild(d),l.forEach(e=>{const t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),a&&(r.value=a),c.appendChild(r),i.appendChild(c),s.push(r)}const c=()=>{const e=new Set(s.map(e=>e.value).filter(Boolean));s.forEach(t=>{const n=JSON.parse(t.dataset.options),o=t.value;t.innerHTML='<option value="">Seleziona...</option>'+n.map(t=>`<option value="${t}" ${e.has(t)&&t!==o?"disabled":""}>${t}</option>`).join(""),t.value=o})};s.forEach(e=>e.addEventListener("change",c)),c()}),T(e),e.classList.add("accordion"),R(e,J),M(e);const C=document.getElementById("subclassSelect");C&&C.addEventListener("change",z)}j&&j.addEventListener("change",()=>{console.log("🔄 Razza cambiata, reset delle selezioni extra..."),p={},g(),N=m(),document.getElementById("languageSelection").innerHTML="",document.getElementById("skillSelectionContainer").innerHTML="",document.getElementById("toolSelectionContainer").innerHTML="",D(),document.getElementById("confirmRaceSelection").style.display="inline-block"});let N=m();function P(e){const t=document.getElementById(e);if(!t)return;const n=[...t.querySelectorAll("select")].some(e=>!e.value);t.classList.toggle("incomplete",n)}function q(e){return e?e.replace(/#.*$/,"").toLowerCase():""}function H(e){const t=new Set;if((N[{skills:"Skill Proficiency",tools:"Tool Proficiency",languages:"Languages",cantrips:"Cantrips"}[e]]||[]).filter(e=>e).forEach(e=>t.add(e.toLowerCase())),window.backgroundData){const n={skills:"skills",tools:"tools",languages:"languages",cantrips:"cantrips"},o=window.backgroundData[n[e]];Array.isArray(o)?o.forEach(e=>t.add(e.toLowerCase())):"string"==typeof o&&t.add(o.toLowerCase()),"cantrips"===e&&window.backgroundData.spellcasting&&window.backgroundData.spellcasting.fixed_spell&&t.add(q(window.backgroundData.spellcasting.fixed_spell))}if(window.currentClassData)if("tools"===e){const e=window.currentClassData.tool_proficiencies;Array.isArray(e)?e.forEach(e=>{const n=e.toLowerCase();n.includes("of your choice")||n.includes(" or ")||t.add(n)}):e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>t.add(e.toLowerCase()))}else if("skills"===e){const e=window.currentClassData.skill_proficiencies;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>t.add(e.toLowerCase()))}else if("languages"===e){const e=window.currentClassData.language_proficiencies;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>t.add(e.toLowerCase()))}else if("cantrips"===e){const e=window.currentClassData.spellcasting;e&&(Array.isArray(e.fixed_cantrips)&&e.fixed_cantrips.forEach(e=>t.add(q(e))),e.fixed_spell&&t.add(q(e.fixed_spell)))}if(window.currentRaceData)if("languages"===e){const e=window.currentRaceData.languages;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>t.add(e.toLowerCase()))}else if("skills"===e){const e=window.currentRaceData.skill_choices;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>t.add(e.toLowerCase()))}else if("tools"===e){const e=window.currentRaceData.tool_choices;e&&Array.isArray(e.fixed)&&e.fixed.forEach(e=>t.add(e.toLowerCase()))}else if("cantrips"===e){const e=window.currentRaceData.spellcasting;e&&(Array.isArray(e.fixed_cantrips)&&e.fixed_cantrips.forEach(e=>t.add(q(e))),e.fixed_spell&&t.add(q(e.fixed_spell)))}return t}function F(e,t){const n=H(e);if(!t)return n;const o=t.map(e=>e.toLowerCase()),a=new Set([...n].filter(e=>!o.includes(e))),i=t.filter((e,t)=>a.has(o[t]));return{taken:new Set([...a,...o]),conflicts:i}}function O(e,t,n=1){const o=[],a=F("languages"),i=F("skills"),l=F("tools");if("race"===t){if(e.languages&&(e.languages.fixed.length>0||e.languages.choice>0)){const t=new Set(e.languages.fixed.map(e=>e.toLowerCase())),n=c.filter(e=>!t.has(e.toLowerCase())),{options:i,note:l}=d("languages",n,a),s=e.languages.fixed.length?`<strong>Lingue Concesse:</strong> ${e.languages.fixed.join(", ")}`:"";o.push({name:"Languages",description:s+l,selection:i,count:e.languages.choice})}if(e.skill_choices){const{options:t,note:n}=d("skills",e.skill_choices.options,i);t.length>0&&o.push({name:"Skill Proficiency",description:"Choose skill proficiencies."+n,selection:t,count:e.skill_choices.number})}if(e.tool_choices){const{options:t,note:n}=d("tools",e.tool_choices.options,l);t.length>0&&o.push({name:"Tool Proficiency",description:"Choose a tool proficiency."+n,selection:t,count:1})}}else if("class"===t){(e.choices||[]).forEach(e=>{if(!e.level||parseInt(e.level)<=n){const t=w[e.name]||e.name,n=(N[t]||[]).filter(e=>e);let s=e.selection||e.options||[],c="";const r={Languages:{type:"languages",taken:a},"Skill Proficiency":{type:"skills",taken:i},"Tool Proficiency":{type:"tools",taken:l}}[t];if(r){const e=d(r.type,s,r.taken,n);s=e.options,c=e.note}const u=c?(e.description||"")+c:e.description;o.push({...e,selection:s,description:u,selected:n})}})}return o}function R(e,t){if(!e)return;e.querySelectorAll(".feature-block").forEach(e=>{const n=e.querySelectorAll("select");if(0===n.length)return;e.classList.add("user-choice");const o=()=>{const t=Array.from(n).some(e=>!e.value);e.classList.toggle("needs-selection",t)};o(),n.forEach(e=>{e.addEventListener("change",()=>{t&&t(e),o()})})})}function J(e){const t=e.dataset.feature,n=e.dataset.index||0;t&&(N[t]||(N[t]=[]),N[t][n]=e.value||void 0,g())}function W(){const e=document.getElementById("finalRecap");if(!e)return;N=m();const t=document.getElementById("userName")?.value||"",n=document.getElementById("characterName")?.value||"",o=document.getElementById("classSelect").selectedOptions[0]?.text||"",a=document.getElementById("subclassSelect").selectedOptions[0]?.text||"",i=document.getElementById("raceSelect").selectedOptions[0]?.text||"",l=document.getElementById("levelSelect")?.value||"",s=document.getElementById("origin")?.value||"",c=document.getElementById("age")?.value||"",r=window.backgroundData&&window.backgroundData.languages||[],d=window.backgroundData&&window.backgroundData.tools||[],u=N.Languages||[],p=N["Tool Proficiency"]||[],g=[...new Set([...r,...u])],h=[...new Set([...d,...p])],f=N.equipment||{},y=[...f.standard||[],...f.class||[],...f.upgrades||[]];let E="";E+=`<p><strong>Nome Utente:</strong> ${t}</p>`,E+=`<p><strong>Nome PG:</strong> ${n}</p>`,E+=`<p><strong>Classe:</strong> ${o}${a?` (${a})`:""}</p>`,E+=`<p><strong>Razza:</strong> ${i}</p>`,E+=`<p><strong>Livello:</strong> ${l}</p>`,E+=`<p><strong>Provenienza:</strong> ${s}</p>`,E+=`<p><strong>Età:</strong> ${c}</p>`,E+=`<p><strong>Lingue:</strong> ${g.join(", ")}</p>`,E+=`<p><strong>Strumenti:</strong> ${h.join(", ")}</p>`,E+=`<p><strong>Equip:</strong> ${y.join(", ")}</p>`,e.innerHTML=E}function V(){let e=null;const t=document.getElementById("ancestrySelect");if(t&&t.value)try{e=JSON.parse(t.value)}catch(e){console.error("Errore nel parsing della Chromatic Ancestry scelta",e)}const n=document.getElementById("toolChoice0")?document.getElementById("toolChoice0").value:null,o=document.getElementById("variantFeatureChoice")?document.getElementById("variantFeatureChoice").value:null,a={},i=document.querySelectorAll(".variantSkillChoice");i.length>0&&(a.skills=[],i.forEach(e=>{e.value&&a.skills.push(e.value)}));const l=document.getElementById("variantSpellChoice");l&&l.value&&(a.spell=l.value);const s=window.backgroundData&&window.backgroundData.languages||[],c=[...new Set([...N.Languages||[],...s])],r={user_name:document.getElementById("userName")?.value||"",name:document.getElementById("characterName").value||"Senza Nome",origin:document.getElementById("origin")?.value||"",age:document.getElementById("age")?.value||"",level:document.getElementById("levelSelect").value||"1",race:document.getElementById("raceSelect").selectedOptions[0]?.text||"Nessuna",class:document.getElementById("classSelect").selectedOptions[0]?.text||"Nessuna",subclass:document.getElementById("subclassSelect").selectedOptions[0]?.text||"Nessuna",background:window.backgroundData?window.backgroundData.name:"Nessuno",stats:{strength:document.getElementById("strFinalScore").textContent,dexterity:document.getElementById("dexFinalScore").textContent,constitution:document.getElementById("conFinalScore").textContent,intelligence:document.getElementById("intFinalScore").textContent,wisdom:document.getElementById("wisFinalScore").textContent,charisma:document.getElementById("chaFinalScore").textContent},racial_bonus:{strength:document.getElementById("strRaceModifier").textContent,dexterity:document.getElementById("dexRaceModifier").textContent,constitution:document.getElementById("conRaceModifier").textContent,intelligence:document.getElementById("intRaceModifier").textContent,wisdom:document.getElementById("wisRaceModifier").textContent,charisma:document.getElementById("chaRaceModifier").textContent},background_proficiencies:window.backgroundData?{skills:window.backgroundData.skills||[],tools:window.backgroundData.tools||[],languages:window.backgroundData.languages||[]}:{skills:[],tools:[],languages:[]},background_feat:window.backgroundData&&window.backgroundData.feat||"",equipment:N.equipment||{standard:[],class:[],upgrades:[]},languages:{selected:c},selections:N,chromatic_ancestry:e,tool_proficiency:n,variant_feature:o,variant_extra:a};console.log("✅ JSON finale generato:"),console.log(JSON.stringify(r,null,2));!function(e,t){const n=new Blob([JSON.stringify(t,null,2)],{type:"application/json"}),o=document.createElement("a");o.href=URL.createObjectURL(n),o.download=e,document.body.appendChild(o),o.click(),document.body.removeChild(o)}(r.name.replace(/[^a-z0-9]/gi,"_").toLowerCase()+"_character.json",r),alert("JSON generato e scaricato!")}A();var U=27;function G(){const e=parseInt(document.getElementById("levelSelect")?.value)||1;["str","dex","con","int","wis","cha"].forEach(t=>{const n=parseInt(document.getElementById(`${t}Points`).textContent),o=parseInt(document.getElementById(`${t}RaceModifier`).textContent),a=document.getElementById(`${t}BackgroundTalent`),i=n+o+(a&&parseInt(a.value)||0),l=document.getElementById(`${t}FinalScore`);1===e&&i>17?(l.textContent="Errore",l.style.color="red"):(l.textContent=i,l.style.color="")}),console.log("🔄 Punteggi Finali aggiornati!")}function K(){document.getElementById("racialBonus1").value="",document.getElementById("racialBonus2").value="",document.getElementById("racialBonus3").value="";["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent="0")}),G()}window.applyRacialBonuses=function(){console.log("⚡ applyRacialBonuses() chiamata!");const e=document.getElementById("racialBonus1").value,t=document.getElementById("racialBonus2").value,n=document.getElementById("racialBonus3").value;if(!e||!t||!n)return void o("Devi selezionare tutti e tre i bonus razziali!");const a={};[e,t,n].forEach(e=>{a[e]=(a[e]||0)+1});const i=Object.values(a);if(!(i.includes(2)&&i.includes(1)&&2===Object.keys(a).length||i.every(e=>1===e)&&3===Object.keys(a).length))return void o("Puoi assegnare +2 a una caratteristica e +1 a un'altra, oppure +1 a tre diverse!");["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent=a[e]?a[e]:"0")}),console.log("✅ Bonus razziali applicati:",a),G()},window.adjustPoints=function(e,t){const n=document.getElementById(e+"Points");let o=parseInt(n.textContent);"add"===t&&U>0&&o<15?(U-=o>=13?2:1,o++):"subtract"===t&&o>8&&(U+=o>13?2:1,o--),n.textContent=o;const a=document.getElementById("pointsRemaining");a&&(a.textContent=U),G()};let Q={},X=null;function Y(e){T(e),e.classList.add("accordion"),M(e)}function Z(){["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"BackgroundTalent");t&&(t.value=0)})}function ee(){Z(),X&&X.fixedAbilities&&X.fixedAbilities.forEach(e=>{const t=Object.keys(e)[0],n=e[t],o=document.getElementById(t+"BackgroundTalent");o&&(o.value=n)});document.querySelectorAll(".featAbilityChoice").forEach(e=>{if(e.value){const t=parseInt(e.dataset.amount||"1"),n=document.getElementById(e.value+"BackgroundTalent");n&&(n.value=t)}}),updateFinalScores()}function te(e,t,n,o){const a=t.querySelector(`.duplicate-${e}-choices`);a&&a.remove();const i=F(e),l=n.filter(e=>i.has(e.toLowerCase()));if(0===l.length)return t.classList.remove("needs-selection","incomplete"),R(t.parentElement),void(backgroundData[e]=n.slice());const s=n.filter(e=>!i.has(e.toLowerCase())),c=o.filter(e=>!i.has(e.toLowerCase())&&!s.includes(e)),r=document.createElement("div");r.className=`duplicate-${e}-choices`;const{label:d,choiceClass:u}={skills:{label:"Abilità",choiceClass:"duplicateSkillChoice"},tools:{label:"Strumenti",choiceClass:"duplicateToolChoice"},languages:{label:"Linguaggi",choiceClass:"duplicateLanguageChoice"}}[e],p=document.createElement("p");p.innerHTML=`<strong>${d} duplicate, scegli sostituti:</strong>`,r.appendChild(p);h(r,l.length,c,u,()=>{const n=Array.from(r.querySelectorAll(`.${u}`)).map(e=>e.value).filter(Boolean);backgroundData[e]=s.concat(n),t.classList.toggle("incomplete",n.length<l.length)}),t.appendChild(r),t.classList.add("needs-selection","incomplete"),R(t.parentElement)}document.addEventListener("DOMContentLoaded",async()=>{if(document.getElementById("step4")){window.backgroundData={name:"",skills:[],tools:[],languages:[],feat:""},t("data/backgrounds.json","backgroundSelect","backgrounds");try{const e=await fetch("data/feats.json");if(!e.ok)throw new Error("Failed to load feats");const t=await e.json();Q=t.feats||{}}catch(e){console.error("Errore caricando i talenti:",e)}document.getElementById("backgroundSelect").addEventListener("change",async e=>{const t=e.target.value;if(t)try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();backgroundData.name=n.name;const o=document.getElementById("backgroundSkills");o.innerHTML="";const a=document.createElement("details");if(a.className="feature-block",a.innerHTML="<summary>Abilità</summary>",backgroundData.skills=Array.isArray(n.skills)?n.skills.slice():[],backgroundData.skills.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Abilità:</strong> ${backgroundData.skills.join(", ")}`,a.appendChild(e)}if(n.skillChoices){const e=n.skillChoices.choose||0,t=F("skills");let o=(n.skillChoices.options||[]).filter(e=>!t.has(e.toLowerCase())),i="";0===o.length&&(o=r.filter(e=>!t.has(e.toLowerCase())),i=" (tutte le abilità disponibili)");const l=document.createElement("p");l.innerHTML=`<strong>Scegli ${e} abilità${i}:</strong>`,a.appendChild(l),h(a,e,o,"backgroundSkillChoice",()=>{const e=Array.from(document.querySelectorAll(".backgroundSkillChoice")).map(e=>e.value).filter(Boolean);backgroundData.skills=(n.skills||[]).concat(e),te("skills",a,backgroundData.skills,r)})}o.appendChild(a),te("skills",a,backgroundData.skills,r),Y(o);const i=document.getElementById("backgroundTools");i.innerHTML="";const l=document.createElement("details");if(l.className="feature-block",l.innerHTML="<summary>Strumenti</summary>",backgroundData.tools=Array.isArray(n.tools)?n.tools.slice():[],Array.isArray(n.tools)&&n.tools.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Strumenti:</strong> ${n.tools.join(", ")}`,l.appendChild(e)}const d=()=>{const e=Array.from(document.querySelectorAll(".backgroundToolChoice")).map(e=>e.value).filter(Boolean),t=Array.isArray(n.tools)?n.tools.slice():[];backgroundData.tools=t.concat(e),te("tools",l,backgroundData.tools,s)},u=F("tools");if(n.tools&&n.tools.choose){const e=n.tools.choose;let t=(n.tools.options||[]).filter(e=>!u.has(e.toLowerCase())),o="";0===t.length&&(t=s.filter(e=>!u.has(e.toLowerCase())),o=" (tutti gli strumenti disponibili)");const a=document.createElement("p");a.innerHTML=`<strong>Scegli ${e} strumento${o}:</strong>`,l.appendChild(a),h(l,e,t,"backgroundToolChoice",d)}if(n.toolChoices){const e=n.toolChoices.choose||0;let t=(n.toolChoices.options||[]).filter(e=>!u.has(e.toLowerCase())),o="";0===t.length&&(t=s.filter(e=>!u.has(e.toLowerCase())),o=" (tutti gli strumenti disponibili)");const a=document.createElement("p");a.innerHTML=`<strong>Scegli ${e} strumento${o}:</strong>`,l.appendChild(a),h(l,e,t,"backgroundToolChoice",d)}i.appendChild(l),te("tools",l,backgroundData.tools,s),Y(i);const p=document.getElementById("backgroundLanguages");p.innerHTML="";const m=document.createElement("details");if(m.className="feature-block",m.innerHTML="<summary>Linguaggi</summary>",backgroundData.languages=Array.isArray(n.languages)?n.languages.slice():[],Array.isArray(n.languages)&&n.languages.length>0){const e=document.createElement("p");e.innerHTML=`<strong>Linguaggi:</strong> ${n.languages.join(", ")}`,m.appendChild(e),p.appendChild(m),te("languages",m,backgroundData.languages,c),Y(p)}else if(n.languages&&n.languages.choose){const e=n.languages.choose,t=t=>{const n=F("languages");let o=(t||[]).filter(e=>!n.has(e.toLowerCase())),a="";0===o.length&&(o=c.filter(e=>!n.has(e.toLowerCase())),a=" (tutte le lingue disponibili)");const i=document.createElement("p");i.innerHTML=`<strong>Scegli ${e} linguaggi${a}:</strong>`,m.appendChild(i),h(m,e,o,"backgroundLanguageChoice",()=>{const e=Array.from(document.querySelectorAll(".backgroundLanguageChoice")).map(e=>e.value).filter(Boolean);backgroundData.languages=e,te("languages",m,backgroundData.languages,c)}),p.appendChild(m),te("languages",m,backgroundData.languages,c),Y(p)};n.languages.any?t(c):t(n.languages.options||[])}else p.appendChild(m),te("languages",m,backgroundData.languages,c),Y(p);const g=document.getElementById("backgroundFeat");g.innerHTML="",backgroundData.feat="",X=null;const f=document.createElement("details");if(f.className="feature-block",f.innerHTML="<summary>Talento</summary>",Array.isArray(n.featOptions)&&n.featOptions.length>0){const e=document.createElement("label");e.htmlFor="backgroundFeatSelect",e.textContent="Feat:";const t=document.createElement("select");t.id="backgroundFeatSelect",t.innerHTML='<option value="">Seleziona un talento</option>'+n.featOptions.map(e=>`<option value="${e}">${e}</option>`).join("");const o=document.createElement("div");o.id="featAbilityChoices",t.addEventListener("change",async()=>{if(X=null,o.innerHTML="",backgroundData.feat=t.value||"",Z(),t.value&&Q[t.value])try{const e=await fetch(Q[t.value]);if(!e.ok)throw new Error("Failed to load feat");const n=await e.json(),a=[];n.ability&&n.ability.forEach(e=>{if(e.choose){const t=document.createElement("select");t.className="featAbilityChoice",t.dataset.amount=e.choose.amount||1,t.innerHTML='<option value="">Seleziona caratteristica</option>'+e.choose.from.map(e=>`<option value="${e}">${e.toUpperCase()}</option>`).join(""),t.addEventListener("change",ee),o.appendChild(t)}else a.push(e)}),X={fixedAbilities:a},ee()}catch(e){console.error("Errore caricando il talento:",e)}else updateFinalScores()}),f.appendChild(e),f.appendChild(t),f.appendChild(o)}g.appendChild(f),R(g),Y(g)}catch(e){handleError(`Errore caricando il background: ${e}`)}})}});let ne=null;function oe(){const e=document.getElementById("classSelect");return e&&e.selectedOptions.length?e.selectedOptions[0].text.trim().normalize("NFC"):""}function ae(){if(!ne)return;const e=m().equipment||{class:[],upgrades:[]},t=oe(),n=parseInt(document.getElementById("levelSelect").value||"1",10),o=document.getElementById("equipmentSelections");if(!o)return;o.innerHTML="";const a=document.createElement("details");a.className="feature-block",a.innerHTML=`<summary>Equipaggiamento Standard</summary><ul>${ne.standard.map(e=>`<li>${e}</li>`).join("")}</ul>`,o.appendChild(a);const i=ne.classes[t];if(i){if(Array.isArray(i.fixed)&&i.fixed.length>0){const e=document.createElement("details");e.className="feature-block",e.innerHTML=`<summary>Equipaggiamento fisso</summary><p>${i.fixed.join(", ")}</p>`,o.appendChild(e)}Array.isArray(i.choices)&&i.choices.forEach((t,n)=>{const a=document.createElement("details");a.className="feature-block needs-selection incomplete",a.innerHTML=`<summary>${t.label||"Scegli"}</summary>`,t.options.forEach((o,i)=>{const l=`equipChoice_${n}_${i}`,s=document.createElement("input");s.type="checkbox"===t.type?"checkbox":"radio",s.name=`equipChoice_${n}`,s.id=l,s.value=o.value||o,e.class&&e.class.includes(s.value)&&(s.checked=!0);const c=document.createElement("label");c.htmlFor=l,c.textContent=o.label||o,a.appendChild(s),a.appendChild(c),a.appendChild(document.createElement("br"))}),o.appendChild(a)})}else{const e=document.createElement("p");e.textContent="Nessun equipaggiamento specifico per questa classe.",o.appendChild(e)}if(ne.upgrades&&n>=(ne.upgrades.minLevel||0)){const t=ne.upgrades,n=document.createElement("details");if(n.className="feature-block",n.innerHTML="<summary>Opzioni Avanzate</summary>",Array.isArray(t.armor)){const o=document.createElement("p");o.innerHTML="<strong>Armatura:</strong>",n.appendChild(o),t.armor.forEach((t,o)=>{const a=`upgradeArmor_${o}`,i=document.createElement("input");i.type="radio",i.name="upgradeArmor",i.id=a,i.value=t,e.upgrades&&e.upgrades.includes(i.value)&&(i.checked=!0);const l=document.createElement("label");l.htmlFor=a,l.textContent=t,n.appendChild(i),n.appendChild(l),n.appendChild(document.createElement("br"))})}if(t.weapon){const o="upgradeWeapon",a=document.createElement("input");a.type="checkbox",a.id=o,a.value=t.weapon,e.upgrades&&e.upgrades.includes(a.value)&&(a.checked=!0);const i=document.createElement("label");i.htmlFor=o,i.textContent=t.weapon,n.appendChild(a),n.appendChild(i)}o.appendChild(n)}T(o),o.classList.add("accordion"),M(o),o.querySelectorAll(".accordion-item.needs-selection").forEach(e=>{const t=()=>{const t=e.querySelectorAll("input:checked").length>0;e.classList.toggle("incomplete",!t)};e.querySelectorAll("input").forEach(e=>e.addEventListener("change",t)),t(),e.querySelectorAll("input:checked").forEach(e=>e.dispatchEvent(new Event("change")))})}document.addEventListener("DOMContentLoaded",async()=>{if(!document.getElementById("step5"))return;try{const e=await fetch("data/equipment.json");if(!e.ok)throw new Error("Failed to load equipment data");const t=await e.json();ne=t,ae();const n=document.getElementById("classSelect"),o=document.getElementById("levelSelect");n&&n.addEventListener("change",ae),o&&o.addEventListener("change",ae)}catch(e){console.error("Error loading equipment:",e)}const e=document.getElementById("confirmEquipment"),t=document.getElementById("equipmentSelections");e&&t&&e.addEventListener("click",()=>{const e=oe(),n=ne.classes[e]||{fixed:[]},o=[];Array.isArray(n.fixed)&&o.push(...n.fixed);const a=[];t.querySelectorAll("input:checked").forEach(e=>{e.name&&e.name.startsWith("equipChoice_")?o.push(e.value):a.push(e.value)});m().equipment={standard:ne.standard,class:o,upgrades:a},g()})}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("step7");e&&(e.innerHTML='\n    <h2>Step 7: Riepilogo ed Esportazione</h2>\n    <div id="finalRecap"></div>\n    <button id="generateJson">Genera JSON</button>\n    \x3c!-- Puoi aggiungere qui anche il pulsante per esportare in PDF --\x3e\n  ')});let ie="",le="",se="";async function ce(e,t){le=t;const n=document.getElementById("raceModal"),o=document.getElementById("raceModalDetails");if(n&&o){try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();o.textContent="",o.appendChild(a(n.name,3))}catch(e){o.textContent="Errore caricando i dettagli della razza."}n.classList.remove("hidden")}}function re(){const e=document.getElementById("raceModal");e&&e.classList.add("hidden")}async function de(e,t){se=t;const n=document.getElementById("backgroundModal"),o=document.getElementById("backgroundModalDetails");if(n&&o){try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();o.textContent="",o.appendChild(a(n.name,3)),n.skills&&o.appendChild(i(`Abilità: ${n.skills.join(", ")}`)),n.tools&&n.tools.length&&o.appendChild(i(`Strumenti: ${n.tools.join(", ")}`))}catch(e){o.textContent="Errore caricando i dettagli del background."}n.classList.remove("hidden")}}function ue(){const e=document.getElementById("backgroundModal");e&&e.classList.add("hidden")}async function pe(e,t){ie=t;const n=document.getElementById("classModal"),o=document.getElementById("classModalDetails");if(n&&o){try{const e=await fetch(t);if(!e.ok)throw new Error("Network response was not ok");const n=await e.json();o.textContent="",o.appendChild(a(n.name,3)),o.appendChild(i(n.description)),o.appendChild(i(`Hit Die: ${n.hit_die}`)),o.appendChild(i(`Saving Throws: ${n.saving_throws.join(", ")}`))}catch(e){o.textContent="Errore caricando i dettagli della classe."}n.classList.remove("hidden")}}function me(){const e=document.getElementById("classModal");e&&e.classList.add("hidden")}document.addEventListener("DOMContentLoaded",()=>{console.log("✅ Main.js caricato!"),t("data/races.json","raceSelect","races"),t("data/classes.json","classSelect","classes"),n("data/classes.json","classes","classList",pe),n("data/races.json","races","raceList",ce),n("data/backgrounds.json","backgrounds","backgroundList",de),["step1","step2","step3","step4","step5","step6","step7"].forEach((t,n)=>{const o=document.getElementById(`btnStep${n+1}`);o&&o.addEventListener("click",()=>{e(t),"step7"===t&&W()})});const a=document.getElementById("classSelect"),l=document.getElementById("levelSelect");a&&a.addEventListener("change",()=>{p={},g();const e=document.getElementById("confirmClassSelection");e&&(e.style.display="inline-block"),async function(){const e=document.getElementById("classSelect").value,t=document.getElementById("classFeatures");if(!e)return window.currentClassData=null,void(t&&(t.textContent="",t.appendChild(i("Seleziona una classe per vedere i tratti."))));try{const t=await fetch(e);if(!t.ok)throw new Error("Network response was not ok");const n=await t.json();window.currentClassData=n,z()}catch(e){o(`Errore caricando le sottoclasse: ${e}`)}}()}),l&&l.addEventListener("change",()=>{z()}),["str","dex","con","int","wis","cha"].forEach(e=>{const t=document.getElementById(e+"RaceModifier");t&&(t.textContent="0");const n=document.getElementById(e+"BackgroundTalent");n&&(n.value="0")}),G();const s=(document.querySelectorAll("input, select, textarea").forEach(e=>{if(!e.id)return;const t=localStorage.getItem(e.id);null!==t&&("checkbox"===e.type||"radio"===e.type?e.checked="true"===t:e.value=t)}),localStorage.getItem("currentStep")),c={nameStep:"step1",classStep:"step2",raceStep:"step3",backgroundStep:"step4",equipmentStep:"step5",pointBuyStep:"step6",recapStep:"step7"}[s]||s;e(c||"step1"),"step7"===(c||"step1")&&W(),document.getElementById("raceSelect").addEventListener("change",D),document.getElementById("levelSelect").addEventListener("change",()=>D()),document.getElementById("generateJson").addEventListener("click",V),document.getElementById("closeClassModal").addEventListener("click",me),document.getElementById("closeRaceModal").addEventListener("click",re),document.getElementById("closeBackgroundModal").addEventListener("click",ue),document.getElementById("addClassButton").addEventListener("click",()=>{const e=document.getElementById("classSelect");e&&(e.value=ie,e.dispatchEvent(new Event("change"))),me()}),document.getElementById("addRaceButton").addEventListener("click",()=>{const e=document.getElementById("raceSelect");if(e){e.value=le,D();const t=document.getElementById("confirmRaceSelection");t&&(t.style.display="inline-block")}re()}),document.getElementById("addBackgroundButton").addEventListener("click",()=>{const e=document.getElementById("backgroundSelect");if(e){e.value=se,e.dispatchEvent(new Event("change"));const t=document.getElementById("confirmBackgroundSelection");t&&(t.style.display="inline-block")}ue()}),document.getElementById("confirmClassSelection").addEventListener("click",async()=>{const e=document.getElementById("classSelect"),t=document.getElementById("subclassSelect"),n=parseInt(document.getElementById("levelSelect")?.value)||1;if(!e.value)return void alert("⚠️ Seleziona una classe prima di procedere!");const o=e.selectedOptions[0]?.text||"";if(t&&n>=({Cleric:1,Warlock:1,Sorcerer:1}[o]||3)&&!t.value)return void alert("⚠️ Seleziona una sottoclasse prima di procedere!");await z();const a=document.getElementById("confirmClassSelection");a&&(a.style.display="none")}),document.getElementById("confirmRaceSelection").addEventListener("click",()=>{document.getElementById("raceSelect").value?document.getElementById("confirmRaceSelection").style.display="none":alert("⚠️ Seleziona una razza prima di procedere!")}),document.getElementById("confirmBackgroundSelection").addEventListener("click",()=>{document.getElementById("backgroundSelect").value?document.getElementById("confirmBackgroundSelection").style.display="none":alert("⚠️ Seleziona un background prima di procedere!")})})}();
